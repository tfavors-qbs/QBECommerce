@page "/"
@using QBExternalWebLibrary.Services.Http;
@using QBExternalWebLibrary.Models.Products
@inject IApiService<SKU, SKUEditViewModel> skuApiService
@inject IApiService<ProductID, ProductID> productIDApiService
@inject IApiService<Length, Length> lengthApiService
@inject IApiService<Diameter, Diameter> diameterApiService

<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<PageTitle>Quality Bolt and Screw - Shop</PageTitle>

<MudText Typo="Typo.h5">Client Portal</MudText>
<MudText Class="mb-8">Welcome to Quality Bolt and Screw client portal, please login!</MudText>

<MudPaper Class="ma-4 pa-4" MaxWidth="500px">
    <MudText Typo="Typo.h6" Class="mx-2">SKU Actions</MudText>
    <MudTextField Label="SKU Name" @bind-Value="skuName" Variant="Variant.Outlined"></MudTextField>
    <MudNumericField Min="0" HideSpinButtons="true" Label="SKU Id" @bind-Value="skuId" Variant="Variant.Outlined"></MudNumericField>
    <MudNumericField Min="0" HideSpinButtons="true" Label="ProductID Id" @bind-Value="productIDId" Variant="Variant.Outlined"></MudNumericField>
    <MudNumericField Min="0" HideSpinButtons="true" Label="Diameter Id" @bind-Value="diameterId" Variant="Variant.Outlined"></MudNumericField>
    <MudNumericField Min="0" HideSpinButtons="true" Label="Length Id" @bind-Value="lengthId" Variant="Variant.Outlined"></MudNumericField>
    <MudStack Row="true" Class="pa-2">
        <MudButton StartIcon="@Icons.Material.TwoTone.Save" Color="Color.Primary" Variant="Variant.Outlined" @onclick="Create">Create</MudButton>
        <MudButton StartIcon="@Icons.Material.TwoTone.MenuBook" Color="Color.Secondary" Variant="Variant.Outlined" @onclick="Read">Read</MudButton>
        <MudButton StartIcon="@Icons.Material.TwoTone.ArrowUpward" Color="Color.Warning" Variant="Variant.Outlined" @onclick="Update">Update</MudButton>
        <MudButton StartIcon="@Icons.Material.TwoTone.Delete" Color="Color.Error" Variant="Variant.Outlined" @onclick="Delete">Delete</MudButton>
    </MudStack>
</MudPaper>
<MudPaper Class="ma-4 pa-4">
    <MudText Typo="Typo.h5">SKUS</MudText>
    <MudDataGrid Items="@skus">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Id" />
            <PropertyColumn Property="x => x.Name" Title="Name" />
            <PropertyColumn Property="x => x.DiameterName" Title="Diameter" />
            <PropertyColumn Property="x => x.LengthName == null ? String.Empty : x.LengthName" Title="Length" />
            <PropertyColumn Property="x => x.ProductIDName" Title="ProductID" />
        </Columns>
    </MudDataGrid>
</MudPaper>
<MudPaper Class="ma-4 pa-4">
    <MudText Typo="Typo.h5">ProductIDs</MudText>
    <MudDataGrid Items="@productIDs">

        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Id" />
            <PropertyColumn Property="x => x.LegacyName" Title="Name" />
        </Columns>
    </MudDataGrid>
</MudPaper>
<MudPaper Class="ma-4 pa-4">
    <MudText Typo="Typo.h5">Diameters</MudText>
    <MudDataGrid Items="@diameters">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Id" />
            <PropertyColumn Property="x => x.Name" Title="Name" />
            <PropertyColumn Property="x => x.DisplayName" Title="Display Name" />
        </Columns>
    </MudDataGrid>
</MudPaper>
<MudPaper Class="ma-4 pa-4">
    <MudText Typo="Typo.h5">Lengths</MudText>
    <MudDataGrid Items="@lengths">
        <Columns>
            <PropertyColumn Property="x => x.Id" Title="Id" />
            <PropertyColumn Property="x => x.Name" Title="Name" />
            <PropertyColumn Property="x => x.DisplayName" Title="Display Name" />
        </Columns>
    </MudDataGrid>
</MudPaper>
<MudPaper Class="ma-4 pa-4">
    <MudText>@(sku?.Name ?? getSkuError)</MudText>
</MudPaper>
<MudPaper Class="ma-4 pa-4">
    <MudText Typo="Typo.h5">Errors</MudText>
    <MudText>@errorMessage</MudText>
</MudPaper>

@code {
    private string errorMessage = "None";
    private string getSkuError = "";
    private IEnumerable<SKUEditViewModel> skus;
    private IEnumerable<ProductID> productIDs;
    private IEnumerable<Diameter> diameters;
    private IEnumerable<Length> lengths;
    private SKU? sku;
    private string? skuName;
    private int skuId;
    private int productIDId;
    private int diameterId;
    private int lengthId;

    protected override async Task OnAfterRenderAsync(bool firstRender) {
        base.OnAfterRender(firstRender);
        if (firstRender)
        {
            skus = await skuApiService.GetAllAsync();
            productIDs = await productIDApiService.GetAllAsync();
            lengths = await lengthApiService.GetAllAsync();
            diameters = await diameterApiService.GetAllAsync();
            StateHasChanged();
        }
    }

    private async void Create() {
        errorMessage = "None";
        SKUEditViewModel newSku = new SKUEditViewModel() {
                Name = skuName,
                ProductIDId = productIDId,
                DiameterId = diameterId,
                LengthId = lengthId
            };
        try {
            await skuApiService.CreateAsync(null, newSku);
            skus = await skuApiService.GetAllAsync();            
        } catch (Exception ex) {
            errorMessage = ex.Message;
        }
        StateHasChanged();
    }

    private async void Read() {
        errorMessage = "None";
        try {
            sku = await skuApiService.GetByIdAsync(Convert.ToInt32(skuId));
        } catch (Exception ex) {
            errorMessage = ex.Message;
        }
        if (sku == null) getSkuError = "SKU does not exist";
        StateHasChanged();
    }

    private async void Update() {
        errorMessage = "None";
        SKUEditViewModel newSku = new SKUEditViewModel() {
                Id = skuId,
                Name = skuName ?? skus.FirstOrDefault(x => x.Id == skuId)?.Name,
                ProductIDId = productIDId,
                DiameterId = diameterId,
                LengthId = lengthId
            };
        try {
            await skuApiService.UpdateAsync(skuId, null, newSku);
            skus = await skuApiService.GetAllAsync();
        } catch (Exception ex) {
            errorMessage = ex.Message;
        }
        StateHasChanged();
    }

    private async void Delete() {
        errorMessage = "None";
        try {
            await skuApiService.DeleteAsync(skuId);
            skus = await skuApiService.GetAllAsync();
        } catch (Exception ex) {
            errorMessage = ex.Message;
        }
        StateHasChanged();
    }
}