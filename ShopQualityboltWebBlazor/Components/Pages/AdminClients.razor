@page "/admin/clients"
@using QBExternalWebLibrary.Services.Http
@using QBExternalWebLibrary.Models
@using Microsoft.AspNetCore.Authorization
@using System.Net.Http.Json
@using ShopQualityboltWebBlazor.Components.CustomComponents
@attribute [Authorize(Roles = "Admin")]
@inject IApiService<Client, ClientEditViewModel> ClientService
@inject IHttpClientFactory HttpClientFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Client Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">Client Management</MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudTextField @bind-Value="searchString" 
                          Placeholder="Search clients..." 
                          Adornment="Adornment.Start" 
                          AdornmentIcon="@Icons.Material.Filled.Search" 
                          IconSize="Size.Medium" 
                          Class="mt-0"
                          Immediate="true"></MudTextField>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Success" 
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateDialog">
                New Client
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
        <MudText Align="Align.Center" Typo="Typo.h6">Loading clients...</MudText>
    }
    else if (clients != null && clients.Any())
    {
        <MudPaper>
            <MudTable Items="@FilteredClients" Hover="true" Striped="true" Dense="true">
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Name</MudTh>
                    <MudTh>Legacy ID</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">@context.Id</MudTd>
                    <MudTd DataLabel="Name">
                        <MudText Typo="Typo.body1"><strong>@context.Name</strong></MudText>
                    </MudTd>
                    <MudTd DataLabel="Legacy ID">
                        <MudChip T="string" Size="Size.Small" Color="Color.Info">@context.LegacyId</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudStack Row="true" Spacing="1">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           OnClick="@(() => OpenEditDialog(context))" 
                                           Title="Edit Client" />
                            <MudIconButton Icon="@Icons.Material.Filled.Inventory" 
                                           Color="Color.Info" 
                                           Size="Size.Small"
                                           OnClick="@(() => NavigateToContractItems(context.Id))" 
                                           Title="View Contract Items" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Color="Color.Error" 
                                           Size="Size.Small"
                                           OnClick="@(() => OpenDeleteDialog(context))" 
                                           Title="Delete Client" />
                        </MudStack>
                    </MudTd>
                </RowTemplate>
                <PagerContent>
                    <MudTablePager />
                </PagerContent>
            </MudTable>
        </MudPaper>
    }
    else
    {
        <MudAlert Severity="Severity.Info">No clients found.</MudAlert>
    }
</MudContainer>

@code {
    private List<ClientEditViewModel> clients = new();
    private string searchString = "";
    private bool loading = false;
    private HttpClient _httpClient;

    private IEnumerable<ClientEditViewModel> FilteredClients =>
        clients.Where(c => 
            string.IsNullOrWhiteSpace(searchString) || 
            c.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
            c.LegacyId.Contains(searchString, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        _httpClient = HttpClientFactory.CreateClient("Auth");
        await LoadClients();
    }

    private async Task LoadClients()
    {
        loading = true;
        try
        {
            var result = await ClientService.GetAllAsync();
            clients = result?.ToList() ?? new List<ClientEditViewModel>();
        }
        catch (Exception ex)
        {
            await LogErrorAsync("UI Error", "Failed to Load Clients", ex.Message, new { exception = ex.ToString() });
            Snackbar.Add($"Error loading clients: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters
        {
            { nameof(ClientDialog.Client), new ClientEditViewModel() },
            { nameof(ClientDialog.IsEdit), false }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ClientDialog>("Create New Client", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadClients();
        }
    }

    private async Task OpenEditDialog(ClientEditViewModel client)
    {
        var parameters = new DialogParameters
        {
            { nameof(ClientDialog.Client), client },
            { nameof(ClientDialog.IsEdit), true }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ClientDialog>("Edit Client", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadClients();
        }
    }

    private async Task OpenDeleteDialog(ClientEditViewModel client)
    {
        var parameters = new DialogParameters
        {
            { nameof(ClientDeleteDialog.Client), client }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true, 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true
        };
        
        var dialog = await DialogService.ShowAsync<ClientDeleteDialog>("Delete Client", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadClients();
        }
    }

    private void NavigateToContractItems(int clientId)
    {
        NavigationManager.NavigateTo($"/admin/contract-items?clientId={clientId}");
    }

    private async Task LogErrorAsync(string errorType, string title, string message, object? additionalData = null)
    {
        try
        {
            var httpClient = HttpClientFactory.CreateClient("Auth");
            var errorLog = new
            {
                ErrorType = errorType,
                ErrorTitle = title,
                ErrorMessage = message,
                AdditionalData = additionalData
            };
            await httpClient.PostAsJsonAsync("api/errorlogs", errorLog);
        }
        catch
        {
            // Silently fail
        }
    }
}
