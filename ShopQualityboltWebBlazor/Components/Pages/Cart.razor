@using Ariba
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using QBExternalWebLibrary.Models.Ariba
@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Pages
@using QBExternalWebLibrary.Services.Authentication
@using QBExternalWebLibrary.Services.Http
@using ShopQualityboltWebBlazor.Services
@using ShopQualityboltWebBlazor.Components.CustomComponents
@using Microsoft.JSInterop
@inject IDialogService DialogService
@inject IAccountManagement Acct
@inject ShoppingCartManagementService ShoppingCartManagementService
@inject ShoppingCartPageApiService shoppingCartPageApiService;
@inject NavigationManager NavigationManager
@inject PunchOutManagementService punchOutManagementService;
@inject IApiService<ShoppingCart, ShoppingCartEVM> shoppingCartApiService
@inject ShoppingCartItemApiService shoppingCartItemApiService;
@inject HttpClient httpClient;
@inject IJSRuntime JSRuntime
@inject QuickOrderApiService QuickOrderApi
@inject ISnackbar Snackbar
@implements IDisposable

<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
    <MudIcon Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Medium" />
    <MudText Class="my-2" Typo="Typo.h5">Shopping Cart</MudText>
</MudStack>
<AuthorizeView>
    <Authorized>
        @if (ShoppingCartManagementService.UsersShoppingCartEVM == null)
        {
            <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">No shopping cart found for user</MudAlert>
        }
        else if (ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs == null || !ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs.Any())
        {
            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">Your cart is empty</MudAlert>
        }
        else
        {
            <MudContainer Style="height: 4px; margin-bottom: 8px;">
                @if (isLoading)
                {
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                }
            </MudContainer>
            <MudTable Items="ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs.Values" FixedHeader="true" Height="70vh" Dense="true" Hover="true" Striped="true" AllowUnsorted="false">
                <HeaderContent>
                    <MudTh>Stock Number</MudTh>
                    <MudTh>Description</MudTh>
                    <MudTh>Price</MudTh>
                    <MudTh>Quantity</MudTh>
                    <MudTh>Total</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate Context="item">
                    <MudTd>@item.ContractItemEditViewModel.CustomerStkNo</MudTd>
                    <MudTd>@item.ContractItemEditViewModel.Description</MudTd>
                    <MudTd>@item.ContractItemEditViewModel.Price.ToString("C")</MudTd>
                    <MudTd>
                        <MudNumericField @bind-Value="item.Quantity" @bind-Value:after="@(() => UpdateQuantity(item))" Min="1" DebounceInterval="500" Variant="Variant.Outlined" Disabled="@isLoading" />
                    </MudTd>
                    <MudTd>@((item.Quantity * item.ContractItemEditViewModel.Price).ToString("C"))</MudTd>
                    <MudTd>
                        <MudButton Color="Color.Error" OnClick="@(() => RemoveItem(item))" Disabled="@(isLoading || IsReadOnly)">
                            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Class="mr-2" />Remove
                        </MudButton>
                    </MudTd>
                </RowTemplate>
            </MudTable>

            <MudGrid Class="mt-4">
                <MudItem xs="12" Class="d-flex flex-column" Style="align-items: flex-end;">
                    <div class="d-flex">
                        <MudText Class="mr-4">Total Items: @totalItems</MudText>
                        <MudText Class="mr-4">Total Quantity: @totalQuantity</MudText>
                        <MudText>Total Price: @totalPrice.ToString("C")</MudText>
                    </div>
                    <div class="d-flex mt-2">
                        <MudButton Color="Color.Info" OnClick="SaveAsQuickOrder" Disabled="@(isLoading || IsReadOnly || !(ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs?.Any() == true))" Class="mr-2">
                            <MudIcon Icon="@Icons.Material.Filled.Bookmark" Size="Size.Small" Class="mr-2" />Save as Quick Order
                        </MudButton>
                        <MudButton Color="Color.Primary" OnClick="PerformCheckout" Disabled="@(isLoading || IsReadOnly)" Class="mr-2">
                            <MudIcon Icon="@Icons.Material.Filled.ShoppingCartCheckout" Size="Size.Small" Class="mr-2" />Check Out
                        </MudButton>
                        <MudButton Color="Color.Secondary" OnClick="ClearCart" Disabled="@(isLoading || IsReadOnly)">
                            <MudIcon Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Class="mr-2" />Clear Cart
                        </MudButton>
                    </div>
                    @if (IsReadOnly)
                    {
                        <div class="d-flex mt-2">
                            <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">Inspect sessions are read only</MudAlert>
                        </div>
                    }
                    
                    @* Debug Test Button - Only visible to Admin users *@
                    <AuthorizeView Roles="Admin" Context="testButtonContext">
                        <Authorized>
                            <div class="d-flex mt-2">
                                <MudButton Color="Color.Error" Variant="Variant.Outlined" OnClick="TestErrorLogging" Size="Size.Small" StartIcon="@Icons.Material.Filled.BugReport">
                                    Test Error Logging
                                </MudButton>
                            </div>
                        </Authorized>
                    </AuthorizeView>
                </MudItem>
            </MudGrid>
        }
    </Authorized>
    <NotAuthorized>
        <MudAlert Severity="Severity.Error" Variant="Variant.Outlined">Must login to manage shopping cart</MudAlert>
    </NotAuthorized>
</AuthorizeView>
<MudDivider />

@code {
    [Parameter]
    public bool IsReadOnly{ get; set; }

    private bool isLoading;
    private int totalQuantity => ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs?.Sum(item => item.Value.Quantity) ?? 0;
    private int totalItems => ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs?.Count() ?? 0;
    private decimal totalPrice => ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs?.Sum(item => item.Value.Quantity * item.Value.ContractItemEditViewModel.Price) ?? 0m;

    protected override void OnInitialized()
    {
        base.OnInitialized();
        ShoppingCartManagementService.UsersShoppingCartEVMChanged += OnUserShoppingCartChanged;
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        if (ShoppingCartManagementService.UsersShoppingCartEVM == null)
        {
            isLoading = true;
            await ShoppingCartManagementService.RefreshUserShoppingCart();
            isLoading = false;
        }
    }

    public void Dispose()
    {
        ShoppingCartManagementService.UsersShoppingCartEVMChanged -= OnUserShoppingCartChanged;
    }

    private void OnUserShoppingCartChanged(ShoppingCartPageEVM shoppingCart)
    {
        StateHasChanged();
    }

    private async Task UpdateQuantity(ShoppingCartItemEVM item)
    {
        isLoading = true;
        await ShoppingCartManagementService.UpdateItemAsync(item);
        isLoading = false;
    }

    private async Task RemoveItem(ShoppingCartItemEVM item)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Removal",
            $"Are you sure you want to remove {item.ContractItemEditViewModel.CustomerStkNo} - {item.ContractItemEditViewModel.Description} from your cart?",
            yesText: "Remove", cancelText: "Cancel",
            options: new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        if (result == true)
        {
            isLoading = true;
            await ShoppingCartManagementService.DeleteItemAsync(item);
            isLoading = false;
        }
    }

    private async Task ClearCart()
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Clear Cart",
            "Are you sure you want to clear your entire cart?",
            yesText: "Clear Cart", cancelText: "Cancel",
            options: new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        if (result == true)
        {
            isLoading = true;
            await ShoppingCartManagementService.ClearItemsAsync();
            isLoading = false;
        }
    }

    private async Task SaveAsQuickOrder()
    {
        var items = ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs?.Values
            .Select(i => new QuickOrderItemRequest
            {
                ContractItemId = i.ContractItemId,
                Quantity = i.Quantity
            })
            .ToList() ?? new();

        if (!items.Any())
        {
            return;
        }

        var parameters = new DialogParameters
        {
            { "Items", items }
        };
        var options = new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true };
        var dialog = await DialogService.ShowAsync<SaveAsQuickOrderDialog>("Save as Quick Order", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is QuickOrderEVM quickOrder)
        {
            Snackbar.Add($"Quick Order '{quickOrder.Name}' saved", Severity.Success);
        }
    }

    private async Task PerformCheckout()
    {
        isLoading = true;
        StateHasChanged();

        // Detailed error tracking
        var debugInfo = new List<string>();
        
        try
        {
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Starting checkout process");
            
            // Step 1: Get PunchOut session
            PunchOutSession session = punchOutManagementService.CurrentPunchOutSession;
            if(session == null)
            {
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] ERROR: No PunchOut session found");
                await ShowDebugError("No PunchOut Session", 
                    "No current punch out session recognized", 
                    debugInfo);
                isLoading = false;
                StateHasChanged();
                return;
            }
            
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] PunchOut Session Found:");
            debugInfo.Add($"  - SessionId: {session.SessionId}");
            debugInfo.Add($"  - PostUrl: {session.PostUrl}");
            debugInfo.Add($"  - BuyerCookie: {session.BuyerCookie}");
            debugInfo.Add($"  - Expires: {session.ExpirationDateTime}");

            // Step 2: Get user's cart
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Fetching user's cart page...");
            ShoppingCartPageEVM usersCartPage = await shoppingCartPageApiService.GetPageAsync();
            if(usersCartPage == null)
            {
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] ERROR: Failed to fetch cart page");
                await ShowDebugError("Cart Not Found", 
                    "Failed to find user's shopping cart page, please refresh the page and try again", 
                    debugInfo);
                isLoading = false;
                StateHasChanged();
                return;
            }
            
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Cart page retrieved successfully");
            debugInfo.Add($"  - Cart Id: {usersCartPage.ShoppingCartEVM?.Id}");
            debugInfo.Add($"  - Items Count: {usersCartPage.ShoppingCartItemEVMs?.Count ?? 0}");

            // Step 3: Get cart items from API
            ShoppingCartEVM usersCart = usersCartPage.ShoppingCartEVM;
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Fetching cart items from API...");
            var usersCartItems = await shoppingCartItemApiService.GetShoppingCartItemsForShoppingCart(usersCart.Id);
            
            if (usersCart == null || usersCartItems == null)
            {
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] ERROR: Cart or items are null");
                debugInfo.Add($"  - Cart is null: {usersCart == null}");
                debugInfo.Add($"  - Items is null: {usersCartItems == null}");
                await ShowDebugError("Cart Items Not Found", 
                    "Failed to find user's shopping cart or items, please refresh the page and try again", 
                    debugInfo);
                isLoading = false;
                StateHasChanged();
                return;
            }
            
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Cart items retrieved: {usersCartItems.Count()} items");

            // Log cart items details for debugging
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Cart items details:");
            foreach (var item in usersCartItems)
            {
                debugInfo.Add($"  - Item #{item.Id}: {item.ContractItem.SKU.Name}");
                debugInfo.Add($"    Description: {item.ContractItem.Description}");
                debugInfo.Add($"    Quantity: {item.Quantity}");
                debugInfo.Add($"    Price: ${item.ContractItem.Price}");
                debugInfo.Add($"    Total: ${item.Quantity * item.ContractItem.Price}");
            }

            // Step 4: Validate cart hasn't changed
            if (usersCartItems.Count() != ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs.Count)
            {
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] ERROR: Cart count mismatch");
                debugInfo.Add($"  - API count: {usersCartItems.Count()}");
                debugInfo.Add($"  - Local count: {ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs.Count}");
                await ShowDebugError("Cart Changed", 
                    "The user's shopping cart has changed, please refresh the page and recheck your cart", 
                    debugInfo);
                isLoading = false;
                StateHasChanged();
                return;
            }

            // Step 5: Validate item details
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Validating cart items...");
            int i = 0;
            foreach (ShoppingCartItem item in usersCartItems)
            {
                ShoppingCartItemEVM localItem = ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs.ElementAt(i).Value;
                if(item.Id != localItem.Id || item.Quantity != localItem.Quantity)
                {
                    debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] ERROR: Item mismatch at index {i}");
                    debugInfo.Add($"  - API Item Id: {item.Id}, Qty: {item.Quantity}");
                    debugInfo.Add($"  - Local Item Id: {localItem.Id}, Qty: {localItem.Quantity}");
                    await ShowDebugError("Cart Items Changed", 
                        "The user's shopping cart has changed, please refresh the page and recheck your cart", 
                        debugInfo);
                    isLoading = false;
                    StateHasChanged();
                    return;
                }
                i++;
            }
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] All items validated successfully");

            // Step 6: Generate cXML order message (BEFORE clearing cart)
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Generating cXML order message...");
            string orderMessage = ShoppingCart.GeneratePunchOutOrderMessage(usersCartItems, session);
            
            if (string.IsNullOrEmpty(orderMessage))
            {
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] ERROR: Order message generation failed");
                await ShowDebugError("Order Generation Failed", 
                    "Failed to generate punch out order message, please try again or contact support", 
                    debugInfo);
                isLoading = false;
                StateHasChanged();
                return;
            }
            
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Order message generated successfully");
            
            // Step 7: Clear the cart (AFTER cXML generation, BEFORE Ariba submission)
            // This ensures the cart data is captured in the cXML but the cart is empty when Ariba takes over
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Clearing cart before Ariba submission...");
            try
            {
                await ShoppingCartManagementService.ClearItemsAsync();
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Cart cleared successfully");
            }
            catch (Exception clearEx)
            {
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] WARNING: Failed to clear cart: {clearEx.Message}");
                // Continue with checkout even if cart clearing fails
                // The error is captured in debugInfo and will be logged if needed
            }
            
            // Note: Debug console logging removed - errors are logged to database for admin review

            // Step 8: POST to Ariba (optional validation step)
            string postUrl = session.PostUrl;
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Posting order to Ariba...");
            debugInfo.Add($"  - POST URL: {postUrl}");
            
            try
            {
                // Create proper XML content with Content-Length header
                var xmlContent = new StringContent(orderMessage, System.Text.Encoding.UTF8, "application/xml");
                
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Sending XML content:");
                debugInfo.Add($"  - Content-Type: application/xml");
                debugInfo.Add($"  - Content-Length: {orderMessage.Length}");
                debugInfo.Add($"  - Encoding: UTF-8");
                
                var result = await httpClient.PostAsync(postUrl, xmlContent);
                
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] POST completed");
                debugInfo.Add($"  - Status Code: {(int)result.StatusCode} ({result.StatusCode})");
                debugInfo.Add($"  - Success: {result.IsSuccessStatusCode}");
                
                // Get response content for debugging
                var responseContent = await result.Content.ReadAsStringAsync();
                debugInfo.Add($"  - Response Length: {responseContent?.Length ?? 0} characters");
                if (!string.IsNullOrEmpty(responseContent))
                {
                    debugInfo.Add($"  - Response (first 500 chars): {responseContent.Substring(0, Math.Min(500, responseContent.Length))}");
                }
                
                if (!result.IsSuccessStatusCode)
                {
                    debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] ERROR: POST failed with status {result.StatusCode}");
                    
                    // Show detailed error with full debug info including cXML that was sent
                    await ShowDebugError("PunchOut POST Failed", 
                        $"Failed to send punch out order. Status: {(int)result.StatusCode} ({result.StatusCode})", 
                        debugInfo,
                        responseContent,
                        orderMessage);
                    
                    isLoading = false;
                    StateHasChanged();
                    return;
                }
                
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Checkout completed successfully!");
                
                // Step 9: Submit cXML via HTML form - this is how PunchOut protocol works
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] Submitting HTML form with cXML to Ariba...");
                await JSRuntime.InvokeVoidAsync("submitPunchOutForm", postUrl, orderMessage);
                
                // Note: The form submission will cause the iframe to navigate/close
                // Ariba handles the rest from here
                // The cart has already been cleared at this point
            }
            catch (HttpRequestException httpEx)
            {
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] HTTP REQUEST ERROR: {httpEx.Message}");
                debugInfo.Add($"  - Inner Exception: {httpEx.InnerException?.Message}");
                await ShowDebugError("Network Error", 
                    $"HTTP request failed: {httpEx.Message}", 
                    debugInfo);
                isLoading = false;
                StateHasChanged();
                return;
            }
            catch (Exception postEx)
            {
                debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] POST ERROR: {postEx.Message}");
                debugInfo.Add($"  - Type: {postEx.GetType().Name}");
                debugInfo.Add($"  - Stack: {postEx.StackTrace}");
                await ShowDebugError("POST Error", 
                    $"Error posting to Ariba: {postEx.Message}", 
                    debugInfo);
                isLoading = false;
                StateHasChanged();
                return;
            }
        }
        catch (Exception ex)
        {
            debugInfo.Add($"[{DateTime.Now:HH:mm:ss.fff}] UNEXPECTED ERROR: {ex.Message}");
            debugInfo.Add($"  - Type: {ex.GetType().Name}");
            debugInfo.Add($"  - Stack: {ex.StackTrace}");
            await ShowDebugError("Unexpected Error", 
                $"An unexpected error occurred: {ex.Message}", 
                debugInfo);
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }
    
    private async Task ShowDebugError(string title, string message, List<string> debugInfo, string? responseContent = null, string? sentCxmlContent = null)
    {
        // Send error log to server for persistence (production debugging)
        try
        {
            var session = punchOutManagementService.CurrentPunchOutSession;
            var statusCode = ExtractStatusCodeFromDebugInfo(debugInfo);
            var errorLog = new
            {
                ErrorType = "PunchOut Checkout",
                ErrorTitle = title,
                ErrorMessage = message,
                StackTrace = string.Join("\n", debugInfo),
                AdditionalData = new
                {
                    SessionId = session?.SessionId ?? "Unknown",
                    PostUrl = session?.PostUrl ?? "Unknown",
                    StatusCode = statusCode,
                    DebugSteps = debugInfo,
                    ResponseContent = responseContent,
                    SentCxmlContent = sentCxmlContent,
                    CartItemCount = ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs?.Count ?? 0,
                    TotalAmount = totalPrice
                },
                SessionId = session?.SessionId,
                StatusCode = statusCode
            };
            
            // Log error to database
            await httpClient.PostAsJsonAsync("api/errorlogs", errorLog);
        }
        catch
        {
            // Silently fail - logging errors shouldn't break the UI
        }
        
        // Show simple error dialog to user - no debug info exposed
        await DialogService.ShowMessageBox(
            title, 
            message + "\n\nThis error has been logged. Please contact support if the issue persists.",
            yesText: "OK",
            options: new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });
    }
    
    private int? ExtractStatusCodeFromDebugInfo(List<string> debugInfo)
    {
        var statusLine = debugInfo.FirstOrDefault(line => line.Contains("Status Code:"));
        if (statusLine != null)
        {
            var match = System.Text.RegularExpressions.Regex.Match(statusLine, @"Status Code: (\d+)");
            if (match.Success && int.TryParse(match.Groups[1].Value, out int code))
            {
                return code;
            }
        }
        return null;
    }

    private async Task TestErrorLogging()
    {
        var debugInfo = new List<string>
        {
            $"[{DateTime.Now:HH:mm:ss.fff}] Test error triggered by admin user",
            $"[{DateTime.Now:HH:mm:ss.fff}] Simulating a cart checkout error",
            $"  - Cart Items: {ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs?.Count ?? 0}",
            $"  - Total Amount: ${totalPrice}",
            $"[{DateTime.Now:HH:mm:ss.fff}] This is a test error to verify logging works",
            $"  - User Agent: {NavigationManager.Uri}",
            $"  - Test Stack Trace Line 1",
            $"  - Test Stack Trace Line 2",
            $"  - Test Stack Trace Line 3"
        };

        await ShowDebugError(
            "Test Error - Cart Operation", 
            "This is a test error generated by the admin to verify the error logging system is working correctly.",
            debugInfo,
            "Test response content: This would normally contain the server response."
        );
    }
}}