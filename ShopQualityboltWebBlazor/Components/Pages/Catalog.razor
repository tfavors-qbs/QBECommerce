@page "/catalog"
@using QBExternalWebLibrary.Models
@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Pages
@using QBExternalWebLibrary.Models.Products
@using QBExternalWebLibrary.Services.Http
@using ShopQualityboltWebBlazor.Components.CustomComponents
@using Microsoft.AspNetCore.Components.Authorization
@using ShopQualityboltWebBlazor.Services
@inject IApiService<ContractItem, ContractItemEditViewModel> contractItemApiService
@inject IApiService<Diameter, Diameter> diameterApiService
@inject IApiService<Length, Length> lengthApiService
@inject IApiService<Shape, Shape> shapeApiService
@inject IApiService<Material, Material> materialApiService
@inject IApiService<Coating, Coating> coatingApiService
@inject IApiService<Thread, Thread> threadApiService
@inject IApiService<Spec, Spec> specApiService
@inject ShoppingCartManagementService ShoppingCartManagementService
@inject PunchOutManagementService punchOutManagementService
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable

<PageTitle>Quality Bolt and Screw - Catalog</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
            <MudText Align="Align.Center" Typo="Typo.h6">Loading catalog items...</MudText>
        }
        else
        {
            @* <MudText>@Status</MudText> *@
            <MudGrid>
                <MudItem xs="12" sm="12" md="12" lg="3" xl="3">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="3">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.h6">Filters</MudText>
                                @if (HasActiveFilters())
                                {
                                    <MudButton Size="Size.Small" Color="Color.Secondary" OnClick="ClearAllFilters" StartIcon="@Icons.Material.Filled.Clear">
                                        Clear All
                                    </MudButton>
                                }
                            </MudStack>
                            <MudDivider />

                            @* Class Filter *@
                            @if (_classes?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0" DisableGutters="true">
                                    <MudExpansionPanel Text="Class" IsInitiallyExpanded="true">
                                        <MudStack Spacing="1">
                                            @foreach (var cls in _classes)
                                            {
                                                <MudCheckBox T="bool" 
                                                            Value="@_selectedClasses.Contains(cls)"
                                                            ValueChanged="@((bool val) => ToggleClassFilter(cls, val))"
                                                            Label="@cls"
                                                            Dense="true"
                                                            Color="Color.Primary" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Group Filter *@
                            @if (_groups?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0" DisableGutters="true">
                                    <MudExpansionPanel Text="Group" IsInitiallyExpanded="true">
                                        <MudStack Spacing="1">
                                            @foreach (var group in _groups)
                                            {
                                                <MudCheckBox T="bool" 
                                                            Value="@_selectedGroups.Contains(group)"
                                                            ValueChanged="@((bool val) => ToggleGroupFilter(group, val))"
                                                            Label="@group"
                                                            Dense="true"
                                                            Color="Color.Primary" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Material Filter *@
                            @if (_materials?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0" DisableGutters="true">
                                    <MudExpansionPanel Text="Material">
                                        <MudStack Spacing="1">
                                            @foreach (var material in _materials)
                                            {
                                                <MudCheckBox T="bool" 
                                                            Value="@_selectedMaterials.Contains(material)"
                                                            ValueChanged="@((bool val) => ToggleMaterialFilter(material, val))"
                                                            Label="@material"
                                                            Dense="true"
                                                            Color="Color.Primary" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Coating Filter *@
                            @if (_coatings?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0" DisableGutters="true">
                                    <MudExpansionPanel Text="Coating">
                                        <MudStack Spacing="1">
                                            @foreach (var coating in _coatings)
                                            {
                                                <MudCheckBox T="bool" 
                                                            Value="@_selectedCoatings.Contains(coating)"
                                                            ValueChanged="@((bool val) => ToggleCoatingFilter(coating, val))"
                                                            Label="@coating"
                                                            Dense="true"
                                                            Color="Color.Primary" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Thread Filter *@
                            @if (_threads?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0" DisableGutters="true">
                                    <MudExpansionPanel Text="Thread">
                                        <MudStack Spacing="1">
                                            @foreach (var thread in _threads)
                                            {
                                                <MudCheckBox T="bool" 
                                                            Value="@_selectedThreads.Contains(thread)"
                                                            ValueChanged="@((bool val) => ToggleThreadFilter(thread, val))"
                                                            Label="@thread"
                                                            Dense="true"
                                                            Color="Color.Primary" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Spec Filter *@
                            @if (_specs?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0" DisableGutters="true">
                                    <MudExpansionPanel Text="Specification">
                                        <MudStack Spacing="1">
                                            @foreach (var spec in _specs)
                                            {
                                                <MudCheckBox T="bool" 
                                                            Value="@_selectedSpecs.Contains(spec)"
                                                            ValueChanged="@((bool val) => ToggleSpecFilter(spec, val))"
                                                            Label="@spec"
                                                            Dense="true"
                                                            Color="Color.Primary" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Diameter Filter *@
                            @if (_diameters?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0" DisableGutters="true">
                                    <MudExpansionPanel Text="Diameter">
                                        <MudStack Spacing="1">
                                            @foreach (var diameter in _diameters)
                                            {
                                                <MudCheckBox T="bool" 
                                                            Value="@_selectedDiameters.Contains(diameter)"
                                                            ValueChanged="@((bool val) => ToggleDiameterFilter(diameter, val))"
                                                            Label="@diameter"
                                                            Dense="true"
                                                            Color="Color.Primary" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Length Filter *@
                            @if (_lengths?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0" DisableGutters="true">
                                    <MudExpansionPanel Text="Length">
                                        <MudStack Spacing="1">
                                            @foreach (var length in _lengths)
                                            {
                                                <MudCheckBox T="bool" 
                                                            Value="@_selectedLengths.Contains(length)"
                                                            ValueChanged="@((bool val) => ToggleLengthFilter(length, val))"
                                                            Label="@length"
                                                            Dense="true"
                                                            Color="Color.Primary" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Shape Filter *@
                            @if (_shapes?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0" DisableGutters="true">
                                    <MudExpansionPanel Text="Shape">
                                        <MudStack Spacing="1">
                                            @foreach (var shape in _shapes)
                                            {
                                                <MudCheckBox T="bool" 
                                                            Value="@_selectedShapes.Contains(shape)"
                                                            ValueChanged="@((bool val) => ToggleShapeFilter(shape, val))"
                                                            Label="@shape"
                                                            Dense="true"
                                                            Color="Color.Primary" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }
                        </MudStack>
                    </MudPaper>
                </MudItem>
                <MudItem xs="12" sm="12" md="12" lg="9" xl="9">
                    <MudStack>
                        <MudPaper Class="mb-4 pa-4" Elevation="2">
                            <MudGrid Class="d-flex align-end">
                                <MudItem xs="12">
                                    <MudText Typo="Typo.h5">@GetClientDisplayName() - Catalog Items</MudText>
                                </MudItem>
                                <MudItem xs="2"><MudText>Results: @_itemsToShow?.Count</MudText></MudItem>
                                <MudItem xs="10"><MudTextField @bind-Value="_searchString" Immediate="true" TextChanged="@Filter" Label="Quick Filter"></MudTextField></MudItem>
                            </MudGrid>
                        </MudPaper>

                        @if (_itemsToShow != null && _itemsToShow.Count != 0) {
                            <MudGrid>
                                <MudItem xs="12" sm="12" md="12" lg="12" xl="7">
                                    <MudStack AlignItems="AlignItems.Center">
                                        <MudPagination @bind-Selected="@_pageSelected" Color="Color.Primary" Count="TotalPages"></MudPagination>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="12" sm="12" md="12" lg="12" xl="5">
                                    <MudGrid>
                                        <MudItem xs="6">
                                            <MudText Class="d-flex align-center justify-end mud-width-full mud-height-full">Items Per Page:</MudText>
                                        </MudItem>
                                        <MudItem xs="6" Class="d-flex align-center justify-start mud-width-full mud-height-full">
                                            <MudChipSet T="int" @bind-SelectedValue="_itemsPerPage" CheckMark SelectionMode="@SelectionMode.SingleSelection">
                                                <MudChip Text="10" Value="10">10</MudChip>
                                                <MudChip Text="25" Value="25">25</MudChip>
                                                <MudChip Text="50" Value="50">50</MudChip>
                                            </MudChipSet>

                                        </MudItem>
                                    </MudGrid>
                                </MudItem>
                            </MudGrid>
                        } else {
                            <MudText Typo="Typo.body1">No Results</MudText>
                        }
                        @if (_itemsToShow != null && _itemsToShow.Count != 0) {
                            foreach (var item in _itemsToShow.GetRange(ShowStartIndex, ShowNumberOfResults)) {
                                ShoppingCartItemEVM existingCartItem = null;
                                ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs.TryGetValue(item.Id, out existingCartItem);
                                <CatalogItem IsReadOnly="isReadOnly" Item="item" OrderQuantity="existingCartItem?.Quantity ?? 1"></CatalogItem>
                            }
                        }
                        @if (_itemsToShow != null && _itemsToShow.Count > 5) {
                            <MudGrid>
                                <MudItem xs="8">
                                    <MudStack AlignItems="AlignItems.Center">
                                        <MudPagination @bind-Selected="@_pageSelected" Color="Color.Primary" Count="TotalPages"></MudPagination>
                                    </MudStack>
                                </MudItem>
                                <MudItem xs="4">
                                    <MudGrid>
                                        <MudItem xs="6">
                                            <MudText Class="d-flex align-center justify-end mud-width-full mud-height-full">Items Per Page:</MudText>
                                        </MudItem>
                                        <MudItem xs="6" Class="d-flex align-center justify-start mud-width-full mud-height-full">
                                            <MudChipSet T="int" @bind-SelectedValue="_itemsPerPage" CheckMark SelectionMode="@SelectionMode.SingleSelection">
                                                <MudChip Text="10" Value="10">10</MudChip>
                                                <MudChip Text="25" Value="25">25</MudChip>
                                                <MudChip Text="50" Value="50">50</MudChip>
                                            </MudChipSet>

                                        </MudItem>
                                    </MudGrid>
                                </MudItem>
                            </MudGrid>
                        }
                    </MudStack>
                </MudItem>
            </MudGrid>
        }
    </Authorized>
    <NotAuthorized>
        Not logged in, no catalog is available.
    </NotAuthorized>
</AuthorizeView>


@code {
    private bool _isLoading = true;
    private string _searchString = "";
    private int _pageSelected = 1;
    private int _itemsPerPage = 10;
    private List<ContractItemEditViewModel> _items = new List<ContractItemEditViewModel>();
    private List<ContractItemEditViewModel>? _itemsToShow = null;
    private List<Diameter> _allDiameters = new List<Diameter>();
    private List<Length> _allLengths = new List<Length>();
    private List<string> _classes = new List<string>();
    private List<string> _groups = new List<string>();
    private List<string> _shapes = new List<string>();
    private List<string> _materials = new List<string>();
    private List<string> _coatings = new List<string>();
    private List<string> _threads = new List<string>();
    private List<string> _specs = new List<string>();
    private List<string> _lengths = new List<string>();
    private List<string> _diameters = new List<string>();
    private List<string> _selectedClasses = new List<string>();
    private List<string> _selectedGroups = new List<string>();
    private List<string> _selectedShapes = new List<string>();
    private List<string> _selectedMaterials = new List<string>();
    private List<string> _selectedCoatings = new List<string>();
    private List<string> _selectedThreads = new List<string>();
    private List<string> _selectedSpecs = new List<string>();
    private List<string> _selectedLengths = new List<string>();
    private List<string> _selectedDiameters = new List<string>();


    private string Status
    {
        get
        {
            string status = "";
            status = _items.Count == 0 ? status + "Items is empty.\n" : "";
            status = _allLengths.Count == 0 ? status + "AllLengths is empty.\n" : "";
            status = _classes.Count == 0 ? status + "Classes is empty.\n" : "";
            status = _groups.Count == 0 ? status + "Groups is empty.\n" : "";
            status = _shapes.Count == 0 ? status + "Shapes is empty.\n" : "";
            status = _materials.Count == 0 ? status + "Materials is empty.\n" : "";
            status = _coatings.Count == 0 ? status + "Coatings is empty.\n" : "";
            status = _threads.Count == 0 ? status + "Threads is empty.\n" : "";
            status = _specs.Count == 0 ? status + "Specs is empty.\n" : "";
            status = _lengths.Count == 0 ? status + "Lengths is empty.\n" : "";
            status = _diameters.Count == 0 ? status + "Diameters is empty.\n" : "";
            return status;
        }
    }

    public int TotalPages {
        get {
            return (_itemsToShow.Count / _itemsPerPage) + 1;
        }
    }

    public int ShowStartIndex {
        get {
            if (_pageSelected * _itemsPerPage > _itemsToShow.Count)
                _pageSelected = (_itemsToShow.Count / _itemsPerPage) + 1;
            return _pageSelected * _itemsPerPage - _itemsPerPage;
        }
    }

    public int ShowNumberOfResults {
        get {
            if (_pageSelected * _itemsPerPage > _itemsToShow.Count) return _itemsToShow.Count % _itemsPerPage;
            else return _itemsPerPage;
        }

    }

    private bool isReadOnly => punchOutManagementService.CurrentPunchOutSession?.PunchOutOperation == Ariba.PunchOutSetupRequestOperation.inspect;

    private string GetClientDisplayName()
    {
        // Use async pattern properly to avoid deadlocks
        var authState = Task.Run(() => AuthenticationStateProvider.GetAuthenticationStateAsync()).GetAwaiter().GetResult();
        var clientName = authState.User.Claims.FirstOrDefault(x => x.Type == "ClientName")?.Value;
        return string.IsNullOrEmpty(clientName) ? "No Client" : clientName;
    }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        ShoppingCartManagementService.UsersShoppingCartEVMChanged += OnUsersShoppingCartChanged;
        
        // Subscribe to authentication state changes to refresh the page when token is updated
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
    }

    private void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        // Force re-render when authentication state changes
        InvokeAsync(() =>
        {
            StateHasChanged();
        });
    }

    protected override async Task OnInitializedAsync() {
        _isLoading = true;
        
        await ShoppingCartManagementService.RefreshUserShoppingCart();

        _items.Clear();
        _items = (await contractItemApiService.GetAllAsync())?.ToList();
        if (_items != null) {
            _allDiameters = (await diameterApiService.GetAllAsync()).ToList();
            _allLengths = (await lengthApiService.GetAllAsync()).ToList();
            _classes = _items.Select(x => x.ClassName ?? "Uncategorized").Distinct().OrderBy(c => c.ToString()).ToList();
            _groups = _items.Select(x => x.GroupName ?? "No Group").Distinct().OrderBy(c => c.ToString()).ToList();
            _materials = _items.Select(x => x.MaterialName ?? "No Material").Distinct().OrderBy(m => m.ToString()).ToList();
            _shapes = _items.Select(x => x.ShapeName ?? "No Shape").Distinct().OrderBy(s => s.ToString()).ToList();
            _coatings = _items.Select(x => x.CoatingName ?? "No Coating").Distinct().OrderBy(c => c.ToString()).ToList();
            _threads = _items.Select(x => x.ThreadName ?? "No Thread").Distinct().OrderBy(t => t.ToString()).ToList();
            _specs = _items.Select(x => x.SpecName ?? "No Spec").Distinct().OrderBy(s => s.ToString()).ToList();
            _lengths = _items
                .Where(c => c.LengthId.HasValue)
                .Join(_allLengths, c => c.LengthId, l => l.Id, (c, l) => new { Name = $"{c.LengthName}", Value = $"{l.Value}" })
                .OrderBy(x => x.Value)
                .Select(x => x.Name).Distinct()
                .Concat(new[] { "No Length" })
                .ToList();
            _diameters = _items
                .Where(c => c.DiameterId.HasValue)
                .Join(_allDiameters, c => c.DiameterId, d => d.Id, (c, d) => new { Name = $"{c.DiameterName}", Value = $"{d.Value}" })
                .OrderBy(x => x.Value)
                .Select(x => x.Name).Distinct()
                .Concat(new[] { "No Diameter" })
                .ToList();

            _itemsToShow = _items.OrderBy(i => _allDiameters.Where(d => d.Id == i.DiameterId).FirstOrDefault()?.Value).ToList();
        }
        
        _isLoading = false;
    }

    public void Dispose()
    {
        ShoppingCartManagementService.UsersShoppingCartEVMChanged -= OnUsersShoppingCartChanged;
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private void OnUsersShoppingCartChanged(ShoppingCartPageEVM cartPage)
    {
        StateHasChanged();
    }

    private Func<ContractItemEditViewModel, object> _DiameterSort => x => {

        return _allDiameters.FirstOrDefault(a => a.DisplayName == x.DiameterName).Value;
    };

    private Func<ContractItemEditViewModel, object> _LengthSort => x => {
        if (x.LengthName == "" || x.LengthName == null) return 0.0;
        else {
            return _allLengths.FirstOrDefault(a => a.DisplayName == x.LengthName).Value;
        }
    };

    private void Filter() {
        _itemsToShow = _items;
        if (_selectedClasses.Count != 0) _itemsToShow = _itemsToShow.Where(i => _selectedClasses.Any(s => s == i.ClassName || (s == "Uncategorized" && i.ClassName == null))).ToList();
        if (_selectedGroups.Count != 0) _itemsToShow = _itemsToShow.Where(i => _selectedGroups.Any(g => g == i.GroupName || (g == "No Group" && i.GroupName == null))).ToList();
        if (_selectedShapes.Count != 0) _itemsToShow = _itemsToShow.Where(i => _selectedShapes.Any(s => s == i.ShapeName || (s == "No Shape" && i.ShapeName == null))).ToList();
        if (_selectedMaterials.Count != 0) _itemsToShow = _itemsToShow.Where(i => _selectedMaterials.Any(s => s == i.MaterialName || (s == "No Material" && i.MaterialName == null))).ToList();
        if (_selectedCoatings.Count != 0) _itemsToShow = _itemsToShow.Where(i => _selectedCoatings.Any(s => s == i.CoatingName || (s == "No Coating" && i.CoatingName == null))).ToList();
        if (_selectedThreads.Count != 0) _itemsToShow = _itemsToShow.Where(i => _selectedThreads.Any(s => s == i.ThreadName || (s == "No Thread" && i.ThreadName == null))).ToList();
        if (_selectedSpecs.Count != 0) _itemsToShow = _itemsToShow.Where(i => _selectedSpecs.Any(s => s == i.SpecName || (s == "No Spec" && i.SpecName == null))).ToList();
        if (_selectedLengths.Count != 0) _itemsToShow = _itemsToShow.Where(i => _selectedLengths.Any(l => l == i.LengthName || (l == "No Length" && i.LengthName == null))).ToList();
        if (_selectedDiameters.Count != 0) _itemsToShow = _itemsToShow.Where(i => _selectedDiameters.Any(d => d == i.DiameterName || (d == "No Diameter" && i.DiameterName == null))).ToList();
        
        // Quick search: split search string into words and match against description and all spec properties
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            var searchWords = _searchString.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            _itemsToShow = _itemsToShow.Where(i => 
                searchWords.All(word => 
                    (i.Description?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.CustomerStkNo?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.ClassName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.GroupName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.ShapeName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.MaterialName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.CoatingName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.ThreadName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.SpecName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.LengthName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.DiameterName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.SKUName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false)
                )
            ).ToList();
        }
        
        _itemsToShow = _itemsToShow.OrderBy(i => _allDiameters.Where(d => d.Id == i.DiameterId).FirstOrDefault()?.Value).ToList();
        
        // Update available filter options based on filtered results
        UpdateAvailableFilterOptions();
    }
    
    private void UpdateAvailableFilterOptions()
    {
        // Get currently filtered items (excluding the filter type we're updating to show available options)
        var baseFilteredItems = _items;
        
        // Apply all filters to get base filtered set
        if (_selectedClasses.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedClasses.Any(s => s == i.ClassName || (s == "Uncategorized" && i.ClassName == null))).ToList();
        if (_selectedGroups.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedGroups.Any(g => g == i.GroupName || (g == "No Group" && i.GroupName == null))).ToList();
        if (_selectedShapes.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedShapes.Any(s => s == i.ShapeName || (s == "No Shape" && i.ShapeName == null))).ToList();
        if (_selectedMaterials.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedMaterials.Any(s => s == i.MaterialName || (s == "No Material" && i.MaterialName == null))).ToList();
        if (_selectedCoatings.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedCoatings.Any(s => s == i.CoatingName || (s == "No Coating" && i.CoatingName == null))).ToList();
        if (_selectedThreads.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedThreads.Any(s => s == i.ThreadName || (s == "No Thread" && i.ThreadName == null))).ToList();
        if (_selectedSpecs.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedSpecs.Any(s => s == i.SpecName || (s == "No Spec" && i.SpecName == null))).ToList();
        if (_selectedLengths.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedLengths.Any(l => l == i.LengthName || (l == "No Length" && i.LengthName == null))).ToList();
        if (_selectedDiameters.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedDiameters.Any(d => d == i.DiameterName || (d == "No Diameter" && i.DiameterName == null))).ToList();
        
        // Update each filter list to show only options that exist in baseFilteredItems
        _classes = baseFilteredItems.Select(x => x.ClassName ?? "Uncategorized").Distinct().OrderBy(c => c).ToList();
        _groups = baseFilteredItems.Select(x => x.GroupName ?? "No Group").Distinct().OrderBy(c => c).ToList();
        _materials = baseFilteredItems.Select(x => x.MaterialName ?? "No Material").Distinct().OrderBy(m => m).ToList();
        _shapes = baseFilteredItems.Select(x => x.ShapeName ?? "No Shape").Distinct().OrderBy(s => s).ToList();
        _coatings = baseFilteredItems.Select(x => x.CoatingName ?? "No Coating").Distinct().OrderBy(c => c).ToList();
        _threads = baseFilteredItems.Select(x => x.ThreadName ?? "No Thread").Distinct().OrderBy(t => t).ToList();
        _specs = baseFilteredItems.Select(x => x.SpecName ?? "No Spec").Distinct().OrderBy(s => s).ToList();
        
        _lengths = baseFilteredItems
            .Where(c => c.LengthId.HasValue)
            .Join(_allLengths, c => c.LengthId, l => l.Id, (c, l) => new { Name = c.LengthName, Value = l.Value })
            .OrderBy(x => x.Value)
            .Select(x => x.Name).Distinct()
            .Concat(new[] { "No Length" })
            .ToList();
            
        _diameters = baseFilteredItems
            .Where(c => c.DiameterId.HasValue)
            .Join(_allDiameters, c => c.DiameterId, d => d.Id, (c, d) => new { Name = c.DiameterName, Value = d.Value })
            .OrderBy(x => x.Value)
            .Select(x => x.Name).Distinct()
            .Concat(new[] { "No Diameter" })
            .ToList();
    }
    
    private bool HasActiveFilters()
    {
        return _selectedClasses.Any() || _selectedGroups.Any() || _selectedMaterials.Any() || 
               _selectedCoatings.Any() || _selectedDiameters.Any() || _selectedLengths.Any() ||
               _selectedShapes.Any() || _selectedThreads.Any() || _selectedSpecs.Any();
    }

    private void ClearAllFilters()
    {
        _selectedClasses.Clear();
        _selectedGroups.Clear();
        _selectedShapes.Clear();
        _selectedMaterials.Clear();
        _selectedCoatings.Clear();
        _selectedThreads.Clear();
        _selectedSpecs.Clear();
        _selectedDiameters.Clear();
        _selectedLengths.Clear();
        Filter();
    }
    
    private void ToggleClassFilter(string cls, bool add)
    {
        if (add) _selectedClasses.Add(cls); else _selectedClasses.Remove(cls);
        Filter();
    }

    private void ToggleGroupFilter(string group, bool add)
    {
        if (add) _selectedGroups.Add(group); else _selectedGroups.Remove(group);
        Filter();
    }

    private void ToggleMaterialFilter(string material, bool add)
    {
        if (add) _selectedMaterials.Add(material); else _selectedMaterials.Remove(material);
        Filter();
    }

    private void ToggleCoatingFilter(string coating, bool add)
    {
        if (add) _selectedCoatings.Add(coating); else _selectedCoatings.Remove(coating);
        Filter();
    }
    
    private void ToggleThreadFilter(string thread, bool add)
    {
        if (add) _selectedThreads.Add(thread); else _selectedThreads.Remove(thread);
        Filter();
    }
    
    private void ToggleSpecFilter(string spec, bool add)
    {
        if (add) _selectedSpecs.Add(spec); else _selectedSpecs.Remove(spec);
        Filter();
    }

    private void ToggleDiameterFilter(string diameter, bool add)
    {
        if (add) _selectedDiameters.Add(diameter); else _selectedDiameters.Remove(diameter);
        Filter();
    }

    private void ToggleLengthFilter(string length, bool add)
    {
        if (add) _selectedLengths.Add(length); else _selectedLengths.Remove(length);
        Filter();
    }
    
    private void ToggleShapeFilter(string shape, bool add)
    {
        if (add) _selectedShapes.Add(shape); else _selectedShapes.Remove(shape);
        Filter();
    }

    private async Task ClassSelectionChanged(List<string> selections) {
        // This method is kept for backward compatibility but now uses the same logic as toggle filters
        _selectedClasses = selections;
        Filter();
    }

    private void GroupSelectionChanged(List<string> selections) {
        _selectedGroups = selections;
        Filter();
    }

    private void ShapeSelectionChanged(List<string> selections) {
        _selectedShapes = selections;
        Filter();
    }

    private void MaterialSelectionChanged(List<string> selections) {
        _selectedMaterials = selections;
        Filter();
    }
    private void CoatingSelectionChanged(List<string> selections) {
        _selectedCoatings = selections;
        Filter();
    }
    private void ThreadSelectionChanged(List<string> selections) {
        _selectedThreads = selections;
        Filter();
    }
    private void SpecSelectionChanged(List<string> selections) {
        _selectedSpecs = selections;
        Filter();
    }
    private void LengthSelectionChanged(List<string> selections) {
        _selectedLengths = selections;
        Filter();
    }
    private void DiameterSelectionChanged(List<string> selections) {
        _selectedDiameters = selections;
        Filter();
    }


    private void ChangeItemsPerPage(int itemsPerPage) {
        _itemsPerPage = itemsPerPage;
        StateHasChanged();
    }
}
