@page "/past-orders"
@using Microsoft.AspNetCore.Authorization
@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Pages
@using QBExternalWebLibrary.Services.Http
@* @using ShopQualityboltWebBlazor.Components.CustomComponents - Uncomment when PastOrderDetailDialog is created (Task 14) *@
@inject PastOrderApiService PastOrderApi
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Past Orders</PageTitle>

<MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-4">
    <MudIcon Icon="@Icons.Material.Filled.History" Size="Size.Medium" />
    <MudText Typo="Typo.h5">Past Orders</MudText>
</MudStack>

<MudContainer Style="height: 4px; margin-bottom: 8px;">
    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
    }
</MudContainer>

<MudGrid>
    <MudItem xs="12" md="3">
        <MudPaper Class="pa-4" Elevation="2">
            <MudTextField @bind-Value="_searchText"
                          Label="Search"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          DebounceInterval="300"
                          Clearable="true" />

            <MudSelect T="string" @bind-Value="_sortBy" Label="Sort By" Class="mt-4">
                <MudSelectItem Value="@("newest")">Date (Newest)</MudSelectItem>
                <MudSelectItem Value="@("oldest")">Date (Oldest)</MudSelectItem>
                <MudSelectItem Value="@("amount-high")">Amount (High to Low)</MudSelectItem>
                <MudSelectItem Value="@("amount-low")">Amount (Low to High)</MudSelectItem>
            </MudSelect>

            @if (_allTags.Any())
            {
                <MudText Typo="Typo.subtitle2" Class="mt-4 mb-2">Filter by Tag</MudText>
                <MudChipSet T="string" SelectionMode="SelectionMode.MultiSelection" @bind-SelectedValues="_selectedTags">
                    @foreach (var tag in _allTags)
                    {
                        <MudChip Value="@tag" Color="Color.Primary" Variant="Variant.Outlined">@tag</MudChip>
                    }
                </MudChipSet>
            }
        </MudPaper>
    </MudItem>

    <MudItem xs="12" md="9">
        <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
            <MudTabPanel Text="My Orders" BadgeData="@_filteredMyOrders.Count()" BadgeColor="Color.Primary">
                @if (!_filteredMyOrders.Any())
                {
                    <MudAlert Severity="Severity.Info">No past orders found.</MudAlert>
                }
                else
                {
                    <MudGrid>
                        @foreach (var order in _filteredMyOrders)
                        {
                            <MudItem xs="12" md="6" lg="4">
                                <MudCard Elevation="2">
                                    <MudCardHeader>
                                        <CardHeaderContent>
                                            <MudText Typo="Typo.h6">@(order.PONumber ?? "No PO")</MudText>
                                            <MudText Typo="Typo.caption">@order.OrderedAt.ToLocalTime().ToString("MMM d, yyyy")</MudText>
                                        </CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        @if (order.Tags.Any())
                                        {
                                            <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mb-2">
                                                @foreach (var tag in order.Tags)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Default">@tag</MudChip>
                                                }
                                            </MudStack>
                                        }
                                        <MudText Typo="Typo.body2">@order.ItemCount items</MudText>
                                        <MudText Typo="Typo.body2">Total: @order.TotalAmount.ToString("C")</MudText>
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudButton Size="Size.Small" Color="Color.Primary" OnClick="@(() => ViewOrder(order))">View</MudButton>
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                }
            </MudTabPanel>

            <MudTabPanel Text="Organization Orders" BadgeData="@_filteredOrgOrders.Count()" BadgeColor="Color.Secondary">
                @if (!_filteredOrgOrders.Any())
                {
                    <MudAlert Severity="Severity.Info">No organization orders found.</MudAlert>
                }
                else
                {
                    <MudGrid>
                        @foreach (var order in _filteredOrgOrders)
                        {
                            <MudItem xs="12" md="6" lg="4">
                                <MudCard Elevation="2">
                                    <MudCardHeader>
                                        <CardHeaderContent>
                                            <MudText Typo="Typo.h6">@(order.PONumber ?? "No PO")</MudText>
                                            <MudText Typo="Typo.caption">@order.OrderedAt.ToLocalTime().ToString("MMM d, yyyy")</MudText>
                                            <MudText Typo="Typo.caption">by @(order.UserName ?? order.UserEmail)</MudText>
                                        </CardHeaderContent>
                                    </MudCardHeader>
                                    <MudCardContent>
                                        @if (order.Tags.Any())
                                        {
                                            <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mb-2">
                                                @foreach (var tag in order.Tags)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Default">@tag</MudChip>
                                                }
                                            </MudStack>
                                        }
                                        <MudText Typo="Typo.body2">@order.ItemCount items</MudText>
                                        <MudText Typo="Typo.body2">Total: @order.TotalAmount.ToString("C")</MudText>
                                    </MudCardContent>
                                    <MudCardActions>
                                        <MudButton Size="Size.Small" Color="Color.Primary" OnClick="@(() => ViewOrder(order))">View</MudButton>
                                    </MudCardActions>
                                </MudCard>
                            </MudItem>
                        }
                    </MudGrid>
                }
            </MudTabPanel>
        </MudTabs>
    </MudItem>
</MudGrid>

@code {
    private bool _loading = true;
    private PastOrderPageEVM? _pageData;
    private string _searchText = "";
    private string _sortBy = "newest";
    private IReadOnlyCollection<string> _selectedTags = new List<string>();
    private List<string> _allTags = new();

    private IEnumerable<PastOrderEVM> _filteredMyOrders => FilterAndSort(_pageData?.MyOrders ?? new());
    private IEnumerable<PastOrderEVM> _filteredOrgOrders => FilterAndSort(_pageData?.OrganizationOrders ?? new());

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _pageData = await PastOrderApi.GetAllAsync();
        _allTags = _pageData?.AllTags ?? new();
        _loading = false;
    }

    private IEnumerable<PastOrderEVM> FilterAndSort(List<PastOrderEVM> orders)
    {
        var filtered = orders.AsEnumerable();

        // Apply search
        if (!string.IsNullOrWhiteSpace(_searchText))
        {
            var search = _searchText.ToLower();
            filtered = filtered.Where(o =>
                (o.PONumber?.ToLower().Contains(search) ?? false) ||
                o.Tags.Any(t => t.ToLower().Contains(search)));
        }

        // Apply tag filter
        if (_selectedTags.Any())
        {
            filtered = filtered.Where(o => o.Tags.Any(t => _selectedTags.Contains(t)));
        }

        // Apply sort
        filtered = _sortBy switch
        {
            "newest" => filtered.OrderByDescending(o => o.OrderedAt),
            "oldest" => filtered.OrderBy(o => o.OrderedAt),
            "amount-high" => filtered.OrderByDescending(o => o.TotalAmount),
            "amount-low" => filtered.OrderBy(o => o.TotalAmount),
            _ => filtered
        };

        return filtered;
    }

    private async Task ViewOrder(PastOrderEVM order)
    {
        // TODO: Uncomment when PastOrderDetailDialog is created (Task 14)
        // var parameters = new DialogParameters
        // {
        //     { "OrderId", order.Id }
        // };
        // var options = new DialogOptions { MaxWidth = MaxWidth.Large, FullWidth = true, CloseButton = true };
        // var dialog = await DialogService.ShowAsync<PastOrderDetailDialog>("Order Details", parameters, options);
        // var result = await dialog.Result;
        //
        // if (!result.Canceled)
        // {
        //     await LoadData();
        // }
        await Task.CompletedTask;
        Snackbar.Add("Order detail view coming soon", Severity.Info);
    }
}
