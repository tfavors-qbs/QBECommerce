@page "/catalog-new"
@using QBExternalWebLibrary.Models
@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Pages
@using QBExternalWebLibrary.Models.Products
@using QBExternalWebLibrary.Services.Http
@using ShopQualityboltWebBlazor.Components.CustomComponents
@using Microsoft.AspNetCore.Components.Authorization
@using ShopQualityboltWebBlazor.Services
@inject IApiService<ContractItem, ContractItemEditViewModel> contractItemApiService
@inject IApiService<Diameter, Diameter> diameterApiService
@inject IApiService<Length, Length> lengthApiService
@inject IApiService<Shape, Shape> shapeApiService
@inject IApiService<Material, Material> materialApiService
@inject IApiService<Coating, Coating> coatingApiService
@inject IApiService<Thread, Thread> threadApiService
@inject IApiService<Spec, Spec> specApiService
@inject ShoppingCartManagementService ShoppingCartManagementService
@inject PunchOutManagementService punchOutManagementService
@inject AuthenticationStateProvider AuthenticationStateProvider
@implements IDisposable

<PageTitle>Quality Bolt and Screw - Modern Catalog</PageTitle>

<AuthorizeView>
    <Authorized>
        @if (_isLoading)
        {
            <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7" />
            <MudText Align="Align.Center" Typo="Typo.h6">Loading catalog items...</MudText>
        }
        else
        {
            <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
                @* Header with Search and Cart *@
                <MudPaper Class="pa-4 mb-4" Elevation="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudStack Row="false" Spacing="1">
                            <MudText Typo="Typo.h4" Color="Color.Primary">Product Catalog</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @_itemsToShow.Count items available @if (_items.Count != _itemsToShow.Count) { <text>(@_items.Count total)</text> }
                            </MudText>
                        </MudStack>
                        <MudStack Row="true" Spacing="3" AlignItems="AlignItems.Center">
                            <MudTextField @bind-Value="_searchString" 
                                         Placeholder="Search products, specs, materials..." 
                                         Adornment="Adornment.Start" 
                                         AdornmentIcon="@Icons.Material.Filled.Search"
                                         Immediate="true"
                                         OnKeyUp="@((e) => Filter())"
                                         Variant="Variant.Outlined"
                                         Clearable="true"
                                         Style="min-width: 400px;"
                                         Class="mt-0" />
                            <MudBadge Content="@(ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs?.Count ?? 0)" Color="Color.Error" Overlap="true" Class="mx-2">
                                <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart" Color="Color.Primary" Size="Size.Large" />
                            </MudBadge>
                        </MudStack>
                    </MudStack>
                </MudPaper>

                <MudGrid>
                    @* Collapsible Filter Sidebar *@
                    <MudItem xs="12" md="3">
                        <MudPaper Class="pa-4" Elevation="1">
                            <MudStack Spacing="3">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">Filters</MudText>
                                    @if (HasActiveFilters())
                                    {
                                        <MudButton Size="Size.Small" Color="Color.Secondary" OnClick="ClearAllFilters" StartIcon="@Icons.Material.Filled.Clear">
                                            Clear All
                                        </MudButton>
                                    }
                                </MudStack>
                                <MudDivider />

                                @* Class Filter *@
                                @if (_classes?.Any() == true)
                                {
                                    <MudExpansionPanels Elevation="0" DisableGutters="true">
                                        <MudExpansionPanel Text="Class" IsInitiallyExpanded="true">
                                            <MudStack Spacing="1">
                                                @foreach (var cls in _classes)
                                                {
                                                    <MudCheckBox T="bool" 
                                                                Value="@_selectedClasses.Contains(cls)"
                                                                ValueChanged="@((bool val) => ToggleClassFilter(cls, val))"
                                                                Label="@cls"
                                                                Dense="true"
                                                                Color="Color.Primary" />
                                                }
                                            </MudStack>
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                }

                                @* Group Filter *@
                                @if (_groups?.Any() == true)
                                {
                                    <MudExpansionPanels Elevation="0" DisableGutters="true">
                                        <MudExpansionPanel Text="Group" IsInitiallyExpanded="true">
                                            <MudStack Spacing="1">
                                                @foreach (var group in _groups)
                                                {
                                                    <MudCheckBox T="bool" 
                                                                Value="@_selectedGroups.Contains(group)"
                                                                ValueChanged="@((bool val) => ToggleGroupFilter(group, val))"
                                                                Label="@group"
                                                                Dense="true"
                                                                Color="Color.Primary" />
                                                }
                                            </MudStack>
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                }

                                @* Material Filter *@
                                @if (_materials?.Any() == true)
                                {
                                    <MudExpansionPanels Elevation="0" DisableGutters="true">
                                        <MudExpansionPanel Text="Material">
                                            <MudStack Spacing="1">
                                                @foreach (var material in _materials)
                                                {
                                                    <MudCheckBox T="bool" 
                                                                Value="@_selectedMaterials.Contains(material)"
                                                                ValueChanged="@((bool val) => ToggleMaterialFilter(material, val))"
                                                                Label="@material"
                                                                Dense="true"
                                                                Color="Color.Primary" />
                                                }
                                            </MudStack>
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                }

                                @* Coating Filter *@
                                @if (_coatings?.Any() == true)
                                {
                                    <MudExpansionPanels Elevation="0" DisableGutters="true">
                                        <MudExpansionPanel Text="Coating">
                                            <MudStack Spacing="1">
                                                @foreach (var coating in _coatings)
                                                {
                                                    <MudCheckBox T="bool" 
                                                                Value="@_selectedCoatings.Contains(coating)"
                                                                ValueChanged="@((bool val) => ToggleCoatingFilter(coating, val))"
                                                                Label="@coating"
                                                                Dense="true"
                                                                Color="Color.Primary" />
                                                }
                                            </MudStack>
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                }

                                @* Diameter Filter *@
                                @if (_diameters?.Any() == true)
                                {
                                    <MudExpansionPanels Elevation="0" DisableGutters="true">
                                        <MudExpansionPanel Text="Diameter">
                                            <MudStack Spacing="1">
                                                @foreach (var diameter in _diameters)
                                                {
                                                    <MudCheckBox T="bool" 
                                                                Value="@_selectedDiameters.Contains(diameter)"
                                                                ValueChanged="@((bool val) => ToggleDiameterFilter(diameter, val))"
                                                                Label="@diameter"
                                                                Dense="true"
                                                                Color="Color.Primary" />
                                                }
                                            </MudStack>
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                }

                                @* Length Filter *@
                                @if (_lengths?.Any() == true)
                                {
                                    <MudExpansionPanels Elevation="0" DisableGutters="true">
                                        <MudExpansionPanel Text="Length">
                                            <MudStack Spacing="1">
                                                @foreach (var length in _lengths)
                                                {
                                                    <MudCheckBox T="bool" 
                                                                Value="@_selectedLengths.Contains(length)"
                                                                ValueChanged="@((bool val) => ToggleLengthFilter(length, val))"
                                                                Label="@length"
                                                                Dense="true"
                                                                Color="Color.Primary" />
                                                }
                                            </MudStack>
                                        </MudExpansionPanel>
                                    </MudExpansionPanels>
                                }
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    @* Product Grid *@
                    <MudItem xs="12" md="9">
                        @* Active Filter Chips *@
                        @if (HasActiveFilters())
                        {
                            <MudPaper Class="pa-3 mb-3" Elevation="0">
                                <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="2">
                                    <MudText Typo="Typo.body2" Class="align-self-center">Active Filters:</MudText>
                                    @foreach (var cls in _selectedClasses)
                                    {
                                        <MudChip T="string" Text="@cls" OnClose="@(() => ToggleClassFilter(cls, false))" Color="Color.Primary" Size="Size.Small" />
                                    }
                                    @foreach (var group in _selectedGroups)
                                    {
                                        <MudChip T="string" Text="@group" OnClose="@(() => ToggleGroupFilter(group, false))" Color="Color.Secondary" Size="Size.Small" />
                                    }
                                    @foreach (var material in _selectedMaterials)
                                    {
                                        <MudChip T="string" Text="@material" OnClose="@(() => ToggleMaterialFilter(material, false))" Color="Color.Tertiary" Size="Size.Small" />
                                    }
                                    @foreach (var coating in _selectedCoatings)
                                    {
                                        <MudChip T="string" Text="@coating" OnClose="@(() => ToggleCoatingFilter(coating, false))" Color="Color.Info" Size="Size.Small" />
                                    }
                                    @foreach (var diameter in _selectedDiameters)
                                    {
                                        <MudChip T="string" Text="@diameter" OnClose="@(() => ToggleDiameterFilter(diameter, false))" Color="Color.Success" Size="Size.Small" />
                                    }
                                    @foreach (var length in _selectedLengths)
                                    {
                                        <MudChip T="string" Text="@length" OnClose="@(() => ToggleLengthFilter(length, false))" Color="Color.Warning" Size="Size.Small" />
                                    }
                                </MudStack>
                            </MudPaper>
                        }

                        @* Product Cards Grid *@
                        <MudGrid Spacing="3">
                            @foreach (var item in _itemsToShow.Skip((_currentPage - 1) * _itemsPerPage).Take(_itemsPerPage))
                            {
                                <MudItem xs="12" sm="6" md="4" lg="3">
                                    <MudCard Elevation="2" Class="catalog-card">
                                        <MudCardHeader>
                                            <CardHeaderContent>
                                                <MudText Typo="Typo.h6" Class="text-truncate">@item.CustomerStkNo</MudText>
                                                @if (!string.IsNullOrEmpty(item.SKUName))
                                                {
                                                    <MudChip T="string" Text="@item.SKUName" Size="Size.Small" Color="Color.Info" />
                                                }
                                            </CardHeaderContent>
                                        </MudCardHeader>
                                        <MudCardContent>
                                            <MudStack Spacing="2">
                                                <MudText Typo="Typo.body2" Class="catalog-description">
                                                    @item.Description
                                                </MudText>
                                                <MudDivider />
                                                <MudStack Spacing="1">
                                                    @if (!string.IsNullOrEmpty(item.DiameterName) && item.DiameterName != "No Diameter")
                                                    {
                                                        <MudStack Row="true" Spacing="1">
                                                            <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Primary" />
                                                            <MudText Typo="Typo.caption">@item.DiameterName</MudText>
                                                        </MudStack>
                                                    }
                                                    @if (!string.IsNullOrEmpty(item.LengthName) && item.LengthName != "No Length")
                                                    {
                                                        <MudStack Row="true" Spacing="1">
                                                            <MudIcon Icon="@Icons.Material.Filled.Straighten" Size="Size.Small" Color="Color.Secondary" />
                                                            <MudText Typo="Typo.caption">@item.LengthName</MudText>
                                                        </MudStack>
                                                    }
                                                    @if (!string.IsNullOrEmpty(item.MaterialName) && item.MaterialName != "No Material")
                                                    {
                                                        <MudStack Row="true" Spacing="1">
                                                            <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" Color="Color.Tertiary" />
                                                            <MudText Typo="Typo.caption">@item.MaterialName</MudText>
                                                        </MudStack>
                                                    }
                                                    @if (!string.IsNullOrEmpty(item.CoatingName) && item.CoatingName != "No Coating")
                                                    {
                                                        <MudStack Row="true" Spacing="1">
                                                            <MudIcon Icon="@Icons.Material.Filled.Brush" Size="Size.Small" Color="Color.Info" />
                                                            <MudText Typo="Typo.caption">@item.CoatingName</MudText>
                                                        </MudStack>
                                                    }
                                                </MudStack>
                                                <MudDivider />
                                                <MudText Typo="Typo.h6" Color="Color.Primary">@item.Price.ToString("C")</MudText>
                                            </MudStack>
                                        </MudCardContent>
                                        <MudCardActions>
                                            <MudButton Variant="Variant.Filled" 
                                                      Color="Color.Primary" 
                                                      StartIcon="@Icons.Material.Filled.AddShoppingCart"
                                                      OnClick="@(() => AddToCart(item))"
                                                      FullWidth="true">
                                                Add to Cart
                                            </MudButton>
                                        </MudCardActions>
                                    </MudCard>
                                </MudItem>
                            }
                        </MudGrid>

                        @* Pagination *@
                        @if (_itemsToShow.Count > _itemsPerPage)
                        {
                            <MudPaper Class="pa-4 mt-4" Elevation="0">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.body2">
                                        Showing @((_currentPage - 1) * _itemsPerPage + 1) - @(Math.Min(_currentPage * _itemsPerPage, _itemsToShow.Count)) of @_itemsToShow.Count items
                                    </MudText>
                                    <MudPagination Count="@((int)Math.Ceiling(_itemsToShow.Count / (double)_itemsPerPage))" 
                                                  @bind-Selected="_currentPage" 
                                                  Color="Color.Primary"
                                                  ShowFirstButton="true"
                                                  ShowLastButton="true" />
                                    <MudSelect T="int" @bind-Value="_itemsPerPage" Variant="Variant.Outlined" Dense="true" Style="max-width: 120px;">
                                        <MudSelectItem Value="12">12 per page</MudSelectItem>
                                        <MudSelectItem Value="24">24 per page</MudSelectItem>
                                        <MudSelectItem Value="48">48 per page</MudSelectItem>
                                        <MudSelectItem Value="96">96 per page</MudSelectItem>
                                    </MudSelect>
                                </MudStack>
                            </MudPaper>
                        }
                    </MudItem>
                </MudGrid>
            </MudContainer>
        }
    </Authorized>
    <NotAuthorized>
        <MudContainer MaxWidth="MaxWidth.Small" Class="mt-16">
            <MudPaper Class="pa-8" Elevation="4">
                <MudStack AlignItems="AlignItems.Center" Spacing="4">
                    <MudIcon Icon="@Icons.Material.Filled.Lock" Size="Size.Large" Color="Color.Primary" />
                    <MudText Typo="Typo.h5" Align="Align.Center">Access Restricted</MudText>
                    <MudText Typo="Typo.body1" Align="Align.Center">
                        Please log in to browse our product catalog.
                    </MudText>
                </MudStack>
            </MudPaper>
        </MudContainer>
    </NotAuthorized>
</AuthorizeView>

<style>
    .catalog-card {
        height: 100%;
        display: flex;
        flex-direction: column;
        transition: transform 0.2s ease-in-out;
    }
    
    .catalog-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    
    .catalog-description {
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 60px;
    }
</style>

@code {
    private List<ContractItemEditViewModel> _items = new();
    private List<ContractItemEditViewModel> _itemsToShow = new();
    private List<Diameter> _allDiameters = new();
    private List<Length> _allLengths = new();
    
    private List<string> _classes = new();
    private List<string> _groups = new();
    private List<string> _shapes = new();
    private List<string> _materials = new();
    private List<string> _coatings = new();
    private List<string> _threads = new();
    private List<string> _specs = new();
    private List<string> _diameters = new();
    private List<string> _lengths = new();

    private List<string> _selectedClasses = new();
    private List<string> _selectedGroups = new();
    private List<string> _selectedShapes = new();
    private List<string> _selectedMaterials = new();
    private List<string> _selectedCoatings = new();
    private List<string> _selectedThreads = new();
    private List<string> _selectedSpecs = new();
    private List<string> _selectedDiameters = new();
    private List<string> _selectedLengths = new();

    private string _searchString = "";
    private bool _isLoading = true;
    private int _currentPage = 1;
    private int _itemsPerPage = 24;

    protected override async Task OnInitializedAsync()
    {
        ShoppingCartManagementService.UsersShoppingCartEVMChanged += OnCartChanged;
        await LoadCatalogData();
    }

    private async Task LoadCatalogData()
    {
        _isLoading = true;
        
        _items = (await contractItemApiService.GetAllAsync())?.ToList() ?? new();
        
        if (_items.Any())
        {
            _allDiameters = (await diameterApiService.GetAllAsync()).ToList();
            _allLengths = (await lengthApiService.GetAllAsync()).ToList();
            
            _classes = _items.Select(x => x.ClassName ?? "Uncategorized").Distinct().OrderBy(c => c).ToList();
            _groups = _items.Select(x => x.GroupName ?? "No Group").Distinct().OrderBy(c => c).ToList();
            _materials = _items.Select(x => x.MaterialName ?? "No Material").Distinct().OrderBy(m => m).ToList();
            _shapes = _items.Select(x => x.ShapeName ?? "No Shape").Distinct().OrderBy(s => s).ToList();
            _coatings = _items.Select(x => x.CoatingName ?? "No Coating").Distinct().OrderBy(c => c).ToList();
            _threads = _items.Select(x => x.ThreadName ?? "No Thread").Distinct().OrderBy(t => t).ToList();
            _specs = _items.Select(x => x.SpecName ?? "No Spec").Distinct().OrderBy(s => s).ToList();
            
            _lengths = _items
                .Where(c => c.LengthId.HasValue)
                .Join(_allLengths, c => c.LengthId, l => l.Id, (c, l) => new { Name = c.LengthName, Value = l.Value })
                .OrderBy(x => x.Value)
                .Select(x => x.Name).Distinct()
                .Concat(new[] { "No Length" })
                .ToList();
                
            _diameters = _items
                .Where(c => c.DiameterId.HasValue)
                .Join(_allDiameters, c => c.DiameterId, d => d.Id, (c, d) => new { Name = c.DiameterName, Value = d.Value })
                .OrderBy(x => x.Value)
                .Select(x => x.Name).Distinct()
                .Concat(new[] { "No Diameter" })
                .ToList();

            _itemsToShow = _items.OrderBy(i => _allDiameters.FirstOrDefault(d => d.Id == i.DiameterId)?.Value ?? 0).ToList();
        }
        
        _isLoading = false;
    }

    private void Filter()
    {
        _itemsToShow = _items;
        
        if (_selectedClasses.Any()) 
            _itemsToShow = _itemsToShow.Where(i => _selectedClasses.Any(s => s == i.ClassName || (s == "Uncategorized" && i.ClassName == null))).ToList();
        
        if (_selectedGroups.Any()) 
            _itemsToShow = _itemsToShow.Where(i => _selectedGroups.Any(g => g == i.GroupName || (g == "No Group" && i.GroupName == null))).ToList();
        
        if (_selectedShapes.Any()) 
            _itemsToShow = _itemsToShow.Where(i => _selectedShapes.Any(s => s == i.ShapeName || (s == "No Shape" && i.ShapeName == null))).ToList();
        
        if (_selectedMaterials.Any()) 
            _itemsToShow = _itemsToShow.Where(i => _selectedMaterials.Any(s => s == i.MaterialName || (s == "No Material" && i.MaterialName == null))).ToList();
        
        if (_selectedCoatings.Any()) 
            _itemsToShow = _itemsToShow.Where(i => _selectedCoatings.Any(s => s == i.CoatingName || (s == "No Coating" && i.CoatingName == null))).ToList();
        
        if (_selectedThreads.Any()) 
            _itemsToShow = _itemsToShow.Where(i => _selectedThreads.Any(s => s == i.ThreadName || (s == "No Thread" && i.ThreadName == null))).ToList();
        
        if (_selectedSpecs.Any()) 
            _itemsToShow = _itemsToShow.Where(i => _selectedSpecs.Any(s => s == i.SpecName || (s == "No Spec" && i.SpecName == null))).ToList();
        
        if (_selectedLengths.Any()) 
            _itemsToShow = _itemsToShow.Where(i => _selectedLengths.Any(l => l == i.LengthName || (l == "No Length" && i.LengthName == null))).ToList();
        
        if (_selectedDiameters.Any()) 
            _itemsToShow = _itemsToShow.Where(i => _selectedDiameters.Any(d => d == i.DiameterName || (d == "No Diameter" && i.DiameterName == null))).ToList();

        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            var searchWords = _searchString.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            _itemsToShow = _itemsToShow.Where(i => 
                searchWords.All(word => 
                    (i.Description?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.CustomerStkNo?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.ClassName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.GroupName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.ShapeName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.MaterialName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.CoatingName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.ThreadName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.SpecName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.LengthName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.DiameterName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.SKUName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false)
                )
            ).ToList();
        }
        
        _itemsToShow = _itemsToShow.OrderBy(i => _allDiameters.FirstOrDefault(d => d.Id == i.DiameterId)?.Value ?? 0).ToList();
        _currentPage = 1; // Reset to first page after filter
        
        // Update available filter options based on filtered results
        UpdateAvailableFilterOptions();
        
        StateHasChanged();
    }
    
    private void UpdateAvailableFilterOptions()
    {
        // Get currently filtered items (excluding the filter type we're updating to show available options)
        var baseFilteredItems = _items;
        
        // Apply all filters to get base filtered set
        if (_selectedClasses.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedClasses.Any(s => s == i.ClassName || (s == "Uncategorized" && i.ClassName == null))).ToList();
        if (_selectedGroups.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedGroups.Any(g => g == i.GroupName || (g == "No Group" && i.GroupName == null))).ToList();
        if (_selectedShapes.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedShapes.Any(s => s == i.ShapeName || (s == "No Shape" && i.ShapeName == null))).ToList();
        if (_selectedMaterials.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedMaterials.Any(s => s == i.MaterialName || (s == "No Material" && i.MaterialName == null))).ToList();
        if (_selectedCoatings.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedCoatings.Any(s => s == i.CoatingName || (s == "No Coating" && i.CoatingName == null))).ToList();
        if (_selectedThreads.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedThreads.Any(s => s == i.ThreadName || (s == "No Thread" && i.ThreadName == null))).ToList();
        if (_selectedSpecs.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedSpecs.Any(s => s == i.SpecName || (s == "No Spec" && i.SpecName == null))).ToList();
        if (_selectedLengths.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedLengths.Any(l => l == i.LengthName || (l == "No Length" && i.LengthName == null))).ToList();
        if (_selectedDiameters.Any()) 
            baseFilteredItems = baseFilteredItems.Where(i => _selectedDiameters.Any(d => d == i.DiameterName || (d == "No Diameter" && i.DiameterName == null))).ToList();
        
        // Update each filter list to show only options that exist in baseFilteredItems
        _classes = baseFilteredItems.Select(x => x.ClassName ?? "Uncategorized").Distinct().OrderBy(c => c).ToList();
        _groups = baseFilteredItems.Select(x => x.GroupName ?? "No Group").Distinct().OrderBy(c => c).ToList();
        _materials = baseFilteredItems.Select(x => x.MaterialName ?? "No Material").Distinct().OrderBy(m => m).ToList();
        _shapes = baseFilteredItems.Select(x => x.ShapeName ?? "No Shape").Distinct().OrderBy(s => s).ToList();
        _coatings = baseFilteredItems.Select(x => x.CoatingName ?? "No Coating").Distinct().OrderBy(c => c).ToList();
        _threads = baseFilteredItems.Select(x => x.ThreadName ?? "No Thread").Distinct().OrderBy(t => t).ToList();
        _specs = baseFilteredItems.Select(x => x.SpecName ?? "No Spec").Distinct().OrderBy(s => s).ToList();
        
        _lengths = baseFilteredItems
            .Where(c => c.LengthId.HasValue)
            .Join(_allLengths, c => c.LengthId, l => l.Id, (c, l) => new { Name = c.LengthName, Value = l.Value })
            .OrderBy(x => x.Value)
            .Select(x => x.Name).Distinct()
            .Concat(new[] { "No Length" })
            .ToList();
            
        _diameters = baseFilteredItems
            .Where(c => c.DiameterId.HasValue)
            .Join(_allDiameters, c => c.DiameterId, d => d.Id, (c, d) => new { Name = c.DiameterName, Value = d.Value })
            .OrderBy(x => x.Value)
            .Select(x => x.Name).Distinct()
            .Concat(new[] { "No Diameter" })
            .ToList();
    }

    private void ToggleClassFilter(string cls, bool add)
    {
        if (add) _selectedClasses.Add(cls); else _selectedClasses.Remove(cls);
        Filter();
    }

    private void ToggleGroupFilter(string group, bool add)
    {
        if (add) _selectedGroups.Add(group); else _selectedGroups.Remove(group);
        Filter();
    }

    private void ToggleMaterialFilter(string material, bool add)
    {
        if (add) _selectedMaterials.Add(material); else _selectedMaterials.Remove(material);
        Filter();
    }

    private void ToggleCoatingFilter(string coating, bool add)
    {
        if (add) _selectedCoatings.Add(coating); else _selectedCoatings.Remove(coating);
        Filter();
    }

    private void ToggleDiameterFilter(string diameter, bool add)
    {
        if (add) _selectedDiameters.Add(diameter); else _selectedDiameters.Remove(diameter);
        Filter();
    }

    private void ToggleLengthFilter(string length, bool add)
    {
        if (add) _selectedLengths.Add(length); else _selectedLengths.Remove(length);
        Filter();
    }

    private bool HasActiveFilters()
    {
        return _selectedClasses.Any() || _selectedGroups.Any() || _selectedMaterials.Any() || 
               _selectedCoatings.Any() || _selectedDiameters.Any() || _selectedLengths.Any();
    }

    private void ClearAllFilters()
    {
        _selectedClasses.Clear();
        _selectedGroups.Clear();
        _selectedShapes.Clear();
        _selectedMaterials.Clear();
        _selectedCoatings.Clear();
        _selectedThreads.Clear();
        _selectedSpecs.Clear();
        _selectedDiameters.Clear();
        _selectedLengths.Clear();
        Filter();
    }

    private async Task AddToCart(ContractItemEditViewModel item)
    {
        var cartItem = new ShoppingCartItemEVM
        {
            ContractItemId = item.Id,
            Quantity = 1
        };
        
        await ShoppingCartManagementService.AddItemAsync(cartItem);
    }

    private void OnCartChanged(ShoppingCartPageEVM cart)
    {
        InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        ShoppingCartManagementService.UsersShoppingCartEVMChanged -= OnCartChanged;
    }
}
