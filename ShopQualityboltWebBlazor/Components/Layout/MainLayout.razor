@inherits LayoutComponentBase
@using QBExternalWebLibrary.Services.Authentication
@using Microsoft.AspNetCore.Components.Authorization
@using ShopQualityboltWebBlazor.Components.CustomComponents
@using ShopQualityboltWebBlazor.Components.Pages
@using ShopQualityboltWebBlazor.Services
@inject IAccountManagement Acct
@inject PunchOutManagementService punchOutManagementService
@inject ShoppingCartManagementService ShoppingCartManagementService

<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudThemeProvider Theme="@_theme" IsDarkMode="_isDarkMode" />
<MudLayout>
    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Never" Elevation="2">
        <NavMenu />
    </MudDrawer>
    <MudPopover Open="@_cartOverlayOpen" AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight">
        <MudPaper Elevation="2" Style="min-width: 600px; height: 93vh; overflow-y: auto; padding: 16px; position: fixed; bottom: 0; right: 0;">
            <Cart IsReadOnly="@(punchOutManagementService.CurrentPunchOutSession?.PunchOutOperation == Ariba.PunchOutSetupRequestOperation.inspect)" />
        </MudPaper>
    </MudPopover>
    <MudOverlay Visible="@_cartOverlayOpen" AutoClose="true" OnClosed="@(() => ToggleCartPopover())" DarkBackground="true" Class="mud-skip-overlay-section" />
    <MudAppBar Elevation="1" Fixed="false">
        @if (!_drawerOpen)
        {
            <MudIconButton Icon="@Icons.Material.Filled.Menu" @onclick="DrawerToggle" />
        }
        <MudSpacer />
        <AuthorizeView>
            <Authorized>
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="0">
                    <MudIcon Icon="@Icons.Material.Filled.Person"></MudIcon>
                    <MudText Class="ma-4">@context.User.Identity?.Name</MudText>
                </MudStack>
                <ShoppingCartFabButton OnClick="ToggleCartPopover"></ShoppingCartFabButton>
                <MudButton Variant="Variant.Text" @onclick="Logout" StartIcon="@Icons.Material.Filled.Logout" Color="Color.Inherit">Logout</MudButton>
            </Authorized>
            <NotAuthorized>
                <MudText>
                    <MudButton Variant="Variant.Text" StartIcon="@Icons.Material.Filled.Login" Color="Color.Inherit" Href="/login">Login</MudButton>
                </MudText>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>
    <MudMainContent Class="pa-4">
        @Body
    </MudMainContent>
</MudLayout>

@code {
    private MudTheme? _theme = null;
    private bool _drawerOpen = true;
    private bool _isDarkMode = false;
    private bool _cartOverlayOpen = false;

    protected override async Task OnInitializedAsync()
    {
        base.OnInitializedAsync();
        _theme = new()
            {
                PaletteLight = new PaletteLight()
                {
                    Primary = "#366D88", // Teflon coating blue
                    Secondary = "#2B5670", // Darker blue-teal
                    Tertiary = "#4A86A0", // Lighter blue-teal
                    Info = "#5BA0C8", // Bright blue
                    Success = "#28A745",
                    Warning = "#FFA500",
                    Error = "#DC143C",
                    AppbarBackground = "#366D88",
                    Background = "#F5F7F9", // Subtle grey-blue background
                    BackgroundGray = "#E8EBED", // Slightly darker grey
                    Surface = "#FFFFFF", // White for cards/papers
                    DrawerBackground = "#FFFFFF",
                },
                PaletteDark = new PaletteDark()
                {
                    Primary = "#366D88",
                    Secondary = "#2B5670",
                    Tertiary = "#4A86A0",
                    Info = "#5BA0C8",
                    Success = "#28A745",
                    Warning = "#FFA500",
                    Error = "#DC143C",
                    AppbarBackground = "#2B5670",
                    Background = "#1A1A1A",
                    BackgroundGray = "#2D2D2D",
                    Surface = "#252525",
                    DrawerBackground = "#252525",
                },
                LayoutProperties = new LayoutProperties()
            };
    }

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void ToggleCartPopover()
    {
        _cartOverlayOpen = !_cartOverlayOpen;
    }

    private void DarkModeToggle()
    {
        _isDarkMode = !_isDarkMode;
    }

    private async void Logout()
    {
        if (await Acct.CheckAuthenticatedAsync())
        {
            await Acct.LogoutAsync();
            // Clear the shopping cart cache to prevent cart data from persisting between user sessions
            ShoppingCartManagementService.ClearCache();
        }
        StateHasChanged();
    }

    public string DarkLightModeButtonIcon => _isDarkMode switch
    {
        true => Icons.Material.Rounded.AutoMode,
        false => Icons.Material.Outlined.DarkMode,
    };
}