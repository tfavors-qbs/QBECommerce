@using QBExternalWebLibrary.Models
@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Products
@using QBExternalWebLibrary.Services.Http
@inject QBSalesQuickOrderApiService QBSalesApi
@inject IApiService<Diameter, Diameter> DiameterApi
@inject IApiService<Length, Length> LengthApi
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Create Quick Order</MudText>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            <MudText Align="Align.Center" Class="my-4">Loading catalog items...</MudText>
        }
        else
        {
            <MudGrid>
                @* Quick Order Details Header *@
                <MudItem xs="12">
                    <MudPaper Class="pa-4" Elevation="1">
                        <MudStack Spacing="2">
                            <MudAlert Severity="Severity.Info" Dense="true">
                                Creating Quick Order for: <strong>@UserName</strong> (@UserEmail)
                            </MudAlert>
                            <MudGrid>
                                <MudItem xs="12" md="6">
                                    <MudTextField @bind-Value="_name"
                                                  Label="Quick Order Name"
                                                  Required="true"
                                                  Variant="Variant.Outlined" />
                                </MudItem>
                                <MudItem xs="12" md="6">
                                    <MudSwitch @bind-Value="_isShared"
                                               Label="Share with organization"
                                               Color="Color.Primary" />
                                </MudItem>
                                <MudItem xs="12">
                                    <MudAutocomplete T="string"
                                                     Label="Tags"
                                                     @bind-Value="_currentTag"
                                                     SearchFunc="SearchTags"
                                                     CoerceText="false"
                                                     CoerceValue="false"
                                                     Adornment="Adornment.End"
                                                     AdornmentIcon="@Icons.Material.Filled.Add"
                                                     OnAdornmentClick="AddTag" />
                                    <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mt-2">
                                        @foreach (var tag in _tags)
                                        {
                                            <MudChip T="string" Color="Color.Primary"
                                                     OnClose="@(() => RemoveTag(tag))"
                                                     CloseIcon="@Icons.Material.Filled.Close">
                                                @tag
                                            </MudChip>
                                        }
                                    </MudStack>
                                </MudItem>
                            </MudGrid>
                        </MudStack>
                    </MudPaper>
                </MudItem>

                @* Pending Items Section *@
                @if (_pendingItems.Any())
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-3" Elevation="1">
                            <MudStack Spacing="2">
                                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.subtitle1"><strong>Items to Add (@_pendingItems.Count)</strong></MudText>
                                    <MudButton Size="Size.Small" Color="Color.Error" OnClick="ClearAllPendingItems">
                                        Clear All
                                    </MudButton>
                                </MudStack>
                                <MudTable Items="_pendingItems" Dense="true" Hover="true" FixedHeader="true" Height="150px">
                                    <HeaderContent>
                                        <MudTh>Stock Number</MudTh>
                                        <MudTh>Description</MudTh>
                                        <MudTh>Qty</MudTh>
                                        <MudTh Style="width: 50px;"></MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.CustomerStkNo</MudTd>
                                        <MudTd>@context.Description</MudTd>
                                        <MudTd>@context.Quantity</MudTd>
                                        <MudTd>
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="@(() => RemovePendingItem(context))" />
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </MudStack>
                        </MudPaper>
                    </MudItem>
                }

                @* Filters Sidebar *@
                <MudItem xs="12" md="3">
                    <MudPaper Class="pa-3" Elevation="1" Style="max-height: 50vh; overflow-y: auto;">
                        <MudStack Spacing="2">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.subtitle1"><strong>Filters</strong></MudText>
                                @if (HasActiveFilters())
                                {
                                    <MudButton Size="Size.Small" Color="Color.Secondary" OnClick="ClearAllFilters" StartIcon="@Icons.Material.Filled.Clear">
                                        Clear
                                    </MudButton>
                                }
                            </MudStack>
                            <MudDivider />

                            @* Search *@
                            <MudTextField @bind-Value="_searchString"
                                          @bind-Value:after="Filter"
                                          Label="Search"
                                          Variant="Variant.Outlined"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          Clearable="true"
                                          Immediate="true"
                                          DebounceInterval="300" />

                            @* Class Filter *@
                            @if (_classes?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="Class" IsInitiallyExpanded="true" Dense="true">
                                        <MudStack Spacing="0">
                                            @foreach (var cls in _classes)
                                            {
                                                <MudCheckBox T="bool"
                                                             Value="@_selectedClasses.Contains(cls)"
                                                             ValueChanged="@((bool val) => ToggleFilter(_selectedClasses, cls, val))"
                                                             Label="@cls"
                                                             Dense="true"
                                                             Size="Size.Small" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Group Filter *@
                            @if (_groups?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="Group" IsInitiallyExpanded="true" Dense="true">
                                        <MudStack Spacing="0">
                                            @foreach (var group in _groups)
                                            {
                                                <MudCheckBox T="bool"
                                                             Value="@_selectedGroups.Contains(group)"
                                                             ValueChanged="@((bool val) => ToggleFilter(_selectedGroups, group, val))"
                                                             Label="@group"
                                                             Dense="true"
                                                             Size="Size.Small" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Material Filter *@
                            @if (_materials?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="Material" Dense="true">
                                        <MudStack Spacing="0">
                                            @foreach (var material in _materials)
                                            {
                                                <MudCheckBox T="bool"
                                                             Value="@_selectedMaterials.Contains(material)"
                                                             ValueChanged="@((bool val) => ToggleFilter(_selectedMaterials, material, val))"
                                                             Label="@material"
                                                             Dense="true"
                                                             Size="Size.Small" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Shape Filter *@
                            @if (_shapes?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="Shape" Dense="true">
                                        <MudStack Spacing="0">
                                            @foreach (var shape in _shapes)
                                            {
                                                <MudCheckBox T="bool"
                                                             Value="@_selectedShapes.Contains(shape)"
                                                             ValueChanged="@((bool val) => ToggleFilter(_selectedShapes, shape, val))"
                                                             Label="@shape"
                                                             Dense="true"
                                                             Size="Size.Small" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Coating Filter *@
                            @if (_coatings?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="Coating" Dense="true">
                                        <MudStack Spacing="0">
                                            @foreach (var coating in _coatings)
                                            {
                                                <MudCheckBox T="bool"
                                                             Value="@_selectedCoatings.Contains(coating)"
                                                             ValueChanged="@((bool val) => ToggleFilter(_selectedCoatings, coating, val))"
                                                             Label="@coating"
                                                             Dense="true"
                                                             Size="Size.Small" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Thread Filter *@
                            @if (_threads?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="Thread" Dense="true">
                                        <MudStack Spacing="0">
                                            @foreach (var thread in _threads)
                                            {
                                                <MudCheckBox T="bool"
                                                             Value="@_selectedThreads.Contains(thread)"
                                                             ValueChanged="@((bool val) => ToggleFilter(_selectedThreads, thread, val))"
                                                             Label="@thread"
                                                             Dense="true"
                                                             Size="Size.Small" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Spec Filter *@
                            @if (_specs?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="Specification" Dense="true">
                                        <MudStack Spacing="0">
                                            @foreach (var spec in _specs)
                                            {
                                                <MudCheckBox T="bool"
                                                             Value="@_selectedSpecs.Contains(spec)"
                                                             ValueChanged="@((bool val) => ToggleFilter(_selectedSpecs, spec, val))"
                                                             Label="@spec"
                                                             Dense="true"
                                                             Size="Size.Small" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Diameter Filter *@
                            @if (_diameters?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="Diameter" Dense="true">
                                        <MudStack Spacing="0">
                                            @foreach (var diameter in _diameters)
                                            {
                                                <MudCheckBox T="bool"
                                                             Value="@_selectedDiameters.Contains(diameter)"
                                                             ValueChanged="@((bool val) => ToggleFilter(_selectedDiameters, diameter, val))"
                                                             Label="@diameter"
                                                             Dense="true"
                                                             Size="Size.Small" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }

                            @* Length Filter *@
                            @if (_lengths?.Any() == true)
                            {
                                <MudExpansionPanels Elevation="0">
                                    <MudExpansionPanel Text="Length" Dense="true">
                                        <MudStack Spacing="0">
                                            @foreach (var length in _lengths)
                                            {
                                                <MudCheckBox T="bool"
                                                             Value="@_selectedLengths.Contains(length)"
                                                             ValueChanged="@((bool val) => ToggleFilter(_selectedLengths, length, val))"
                                                             Label="@length"
                                                             Dense="true"
                                                             Size="Size.Small" />
                                            }
                                        </MudStack>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }
                        </MudStack>
                    </MudPaper>
                </MudItem>

                @* Items Table *@
                <MudItem xs="12" md="9">
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Showing @_filteredItems.Count of @_allItems.Count items
                    </MudText>
                    <MudTable Items="_filteredItems"
                              Dense="true"
                              Hover="true"
                              FixedHeader="true"
                              Height="40vh"
                              RowsPerPage="25">
                        <HeaderContent>
                            <MudTh>Stock Number</MudTh>
                            <MudTh>Description</MudTh>
                            <MudTh>Price</MudTh>
                            <MudTh Style="width: 100px;">Qty</MudTh>
                            <MudTh Style="width: 80px;">Add</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Stock Number">@context.CustomerStkNo</MudTd>
                            <MudTd DataLabel="Description">@context.Description</MudTd>
                            <MudTd DataLabel="Price">@context.Price.ToString("C")</MudTd>
                            <MudTd DataLabel="Qty">
                                <MudNumericField @bind-Value="_quantities[context.Id]"
                                                 Min="1"
                                                 Variant="Variant.Outlined"
                                                 Style="width: 70px;"
                                                 HideSpinButtons="true" />
                            </MudTd>
                            <MudTd>
                                <MudIconButton Icon="@Icons.Material.Filled.Add"
                                               Color="Color.Primary"
                                               Size="Size.Small"
                                               OnClick="@(() => AddToPending(context))" />
                            </MudTd>
                        </RowTemplate>
                        <PagerContent>
                            <MudTablePager PageSizeOptions="new int[] { 25, 50, 100 }" />
                        </PagerContent>
                    </MudTable>
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="Create"
                   Disabled="@(string.IsNullOrWhiteSpace(_name) || _saving)">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
            }
            Create Quick Order
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public string UserId { get; set; } = string.Empty;

    [Parameter]
    public string UserName { get; set; } = string.Empty;

    [Parameter]
    public string UserEmail { get; set; } = string.Empty;

    [Parameter]
    public int ClientId { get; set; }

    private bool _loading = true;
    private bool _saving;

    // Quick Order fields
    private string _name = "";
    private bool _isShared;
    private List<string> _tags = new();
    private string _currentTag = "";
    private List<string> _availableTags = new() { "Favorites", "Monthly Order", "Restocking", "Emergency" };

    // Pending items (to be added when Create is clicked)
    private List<PendingItem> _pendingItems = new();

    // Catalog items
    private List<ContractItemEditViewModel> _allItems = new();
    private List<ContractItemEditViewModel> _filteredItems = new();
    private Dictionary<int, int> _quantities = new();

    private List<Diameter> _allDiameters = new();
    private List<Length> _allLengths = new();

    // Filter options (dynamically updated)
    private List<string> _classes = new();
    private List<string> _groups = new();
    private List<string> _materials = new();
    private List<string> _shapes = new();
    private List<string> _coatings = new();
    private List<string> _threads = new();
    private List<string> _specs = new();
    private List<string> _diameters = new();
    private List<string> _lengths = new();

    // Selected filters
    private HashSet<string> _selectedClasses = new();
    private HashSet<string> _selectedGroups = new();
    private HashSet<string> _selectedMaterials = new();
    private HashSet<string> _selectedShapes = new();
    private HashSet<string> _selectedCoatings = new();
    private HashSet<string> _selectedThreads = new();
    private HashSet<string> _selectedSpecs = new();
    private HashSet<string> _selectedDiameters = new();
    private HashSet<string> _selectedLengths = new();
    private string _searchString = "";

    protected override async Task OnInitializedAsync()
    {
        _loading = true;

        var items = await QBSalesApi.GetContractItemsByClientAsync(ClientId);
        if (items != null)
        {
            _allItems = items.ToList();
            _allDiameters = (await DiameterApi.GetAllAsync())?.ToList() ?? new();
            _allLengths = (await LengthApi.GetAllAsync())?.ToList() ?? new();

            // Initialize quantities to 1 for all items
            _quantities = _allItems.ToDictionary(i => i.Id, _ => 1);

            // Build initial filter options
            BuildFilterOptions(_allItems);

            _filteredItems = _allItems.OrderBy(i => _allDiameters.FirstOrDefault(d => d.Id == i.DiameterId)?.Value ?? 0).ToList();
        }

        _loading = false;
    }

    private void BuildFilterOptions(IEnumerable<ContractItemEditViewModel> items)
    {
        _classes = items.Select(x => x.ClassName ?? "Uncategorized").Distinct().OrderBy(c => c).ToList();
        _groups = items.Select(x => x.GroupName ?? "No Group").Distinct().OrderBy(c => c).ToList();
        _materials = items.Select(x => x.MaterialName ?? "No Material").Distinct().OrderBy(m => m).ToList();
        _shapes = items.Select(x => x.ShapeName ?? "No Shape").Distinct().OrderBy(s => s).ToList();
        _coatings = items.Select(x => x.CoatingName ?? "No Coating").Distinct().OrderBy(c => c).ToList();
        _threads = items.Select(x => x.ThreadName ?? "No Thread").Distinct().OrderBy(t => t).ToList();
        _specs = items.Select(x => x.SpecName ?? "No Spec").Distinct().OrderBy(s => s).ToList();

        _diameters = items
            .Where(c => c.DiameterId.HasValue)
            .Join(_allDiameters, c => c.DiameterId, d => d.Id, (c, d) => new { Name = c.DiameterName, Value = d.Value })
            .OrderBy(x => x.Value)
            .Select(x => x.Name)
            .Distinct()
            .Concat(new[] { "No Diameter" })
            .ToList();

        _lengths = items
            .Where(c => c.LengthId.HasValue)
            .Join(_allLengths, c => c.LengthId, l => l.Id, (c, l) => new { Name = c.LengthName, Value = l.Value })
            .OrderBy(x => x.Value)
            .Select(x => x.Name)
            .Distinct()
            .Concat(new[] { "No Length" })
            .ToList();
    }

    private void Filter()
    {
        _filteredItems = _allItems;

        if (_selectedClasses.Any())
            _filteredItems = _filteredItems.Where(i => _selectedClasses.Contains(i.ClassName ?? "Uncategorized")).ToList();
        if (_selectedGroups.Any())
            _filteredItems = _filteredItems.Where(i => _selectedGroups.Contains(i.GroupName ?? "No Group")).ToList();
        if (_selectedMaterials.Any())
            _filteredItems = _filteredItems.Where(i => _selectedMaterials.Contains(i.MaterialName ?? "No Material")).ToList();
        if (_selectedShapes.Any())
            _filteredItems = _filteredItems.Where(i => _selectedShapes.Contains(i.ShapeName ?? "No Shape")).ToList();
        if (_selectedCoatings.Any())
            _filteredItems = _filteredItems.Where(i => _selectedCoatings.Contains(i.CoatingName ?? "No Coating")).ToList();
        if (_selectedThreads.Any())
            _filteredItems = _filteredItems.Where(i => _selectedThreads.Contains(i.ThreadName ?? "No Thread")).ToList();
        if (_selectedSpecs.Any())
            _filteredItems = _filteredItems.Where(i => _selectedSpecs.Contains(i.SpecName ?? "No Spec")).ToList();
        if (_selectedDiameters.Any())
            _filteredItems = _filteredItems.Where(i => _selectedDiameters.Contains(i.DiameterName ?? "No Diameter")).ToList();
        if (_selectedLengths.Any())
            _filteredItems = _filteredItems.Where(i => _selectedLengths.Contains(i.LengthName ?? "No Length")).ToList();

        // Text search
        if (!string.IsNullOrWhiteSpace(_searchString))
        {
            var searchWords = _searchString.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            _filteredItems = _filteredItems.Where(i =>
                searchWords.All(word =>
                    (i.Description?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.CustomerStkNo?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.ClassName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.GroupName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.ShapeName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.MaterialName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.CoatingName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.ThreadName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.SpecName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.LengthName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.DiameterName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false) ||
                    (i.SKUName?.Contains(word, StringComparison.OrdinalIgnoreCase) ?? false)
                )
            ).ToList();
        }

        _filteredItems = _filteredItems.OrderBy(i => _allDiameters.FirstOrDefault(d => d.Id == i.DiameterId)?.Value ?? 0).ToList();

        // Update available filter options based on filtered results
        UpdateAvailableFilterOptions();
    }

    private void UpdateAvailableFilterOptions()
    {
        // Get base filtered items (apply all current filters)
        var baseFilteredItems = _allItems.AsEnumerable();

        if (_selectedClasses.Any())
            baseFilteredItems = baseFilteredItems.Where(i => _selectedClasses.Contains(i.ClassName ?? "Uncategorized"));
        if (_selectedGroups.Any())
            baseFilteredItems = baseFilteredItems.Where(i => _selectedGroups.Contains(i.GroupName ?? "No Group"));
        if (_selectedMaterials.Any())
            baseFilteredItems = baseFilteredItems.Where(i => _selectedMaterials.Contains(i.MaterialName ?? "No Material"));
        if (_selectedShapes.Any())
            baseFilteredItems = baseFilteredItems.Where(i => _selectedShapes.Contains(i.ShapeName ?? "No Shape"));
        if (_selectedCoatings.Any())
            baseFilteredItems = baseFilteredItems.Where(i => _selectedCoatings.Contains(i.CoatingName ?? "No Coating"));
        if (_selectedThreads.Any())
            baseFilteredItems = baseFilteredItems.Where(i => _selectedThreads.Contains(i.ThreadName ?? "No Thread"));
        if (_selectedSpecs.Any())
            baseFilteredItems = baseFilteredItems.Where(i => _selectedSpecs.Contains(i.SpecName ?? "No Spec"));
        if (_selectedDiameters.Any())
            baseFilteredItems = baseFilteredItems.Where(i => _selectedDiameters.Contains(i.DiameterName ?? "No Diameter"));
        if (_selectedLengths.Any())
            baseFilteredItems = baseFilteredItems.Where(i => _selectedLengths.Contains(i.LengthName ?? "No Length"));

        var itemsList = baseFilteredItems.ToList();

        // Update each filter list to show only options that exist in filtered items
        _classes = itemsList.Select(x => x.ClassName ?? "Uncategorized").Distinct().OrderBy(c => c).ToList();
        _groups = itemsList.Select(x => x.GroupName ?? "No Group").Distinct().OrderBy(c => c).ToList();
        _materials = itemsList.Select(x => x.MaterialName ?? "No Material").Distinct().OrderBy(m => m).ToList();
        _shapes = itemsList.Select(x => x.ShapeName ?? "No Shape").Distinct().OrderBy(s => s).ToList();
        _coatings = itemsList.Select(x => x.CoatingName ?? "No Coating").Distinct().OrderBy(c => c).ToList();
        _threads = itemsList.Select(x => x.ThreadName ?? "No Thread").Distinct().OrderBy(t => t).ToList();
        _specs = itemsList.Select(x => x.SpecName ?? "No Spec").Distinct().OrderBy(s => s).ToList();

        _diameters = itemsList
            .Where(c => c.DiameterId.HasValue)
            .Join(_allDiameters, c => c.DiameterId, d => d.Id, (c, d) => new { Name = c.DiameterName, Value = d.Value })
            .OrderBy(x => x.Value)
            .Select(x => x.Name)
            .Distinct()
            .Concat(new[] { "No Diameter" })
            .ToList();

        _lengths = itemsList
            .Where(c => c.LengthId.HasValue)
            .Join(_allLengths, c => c.LengthId, l => l.Id, (c, l) => new { Name = c.LengthName, Value = l.Value })
            .OrderBy(x => x.Value)
            .Select(x => x.Name)
            .Distinct()
            .Concat(new[] { "No Length" })
            .ToList();
    }

    private void ToggleFilter(HashSet<string> set, string value, bool add)
    {
        if (add) set.Add(value); else set.Remove(value);
        Filter();
    }

    private bool HasActiveFilters()
    {
        return _selectedClasses.Any() || _selectedGroups.Any() || _selectedMaterials.Any() ||
               _selectedShapes.Any() || _selectedCoatings.Any() || _selectedThreads.Any() ||
               _selectedSpecs.Any() || _selectedDiameters.Any() || _selectedLengths.Any() ||
               !string.IsNullOrWhiteSpace(_searchString);
    }

    private void ClearAllFilters()
    {
        _selectedClasses.Clear();
        _selectedGroups.Clear();
        _selectedMaterials.Clear();
        _selectedShapes.Clear();
        _selectedCoatings.Clear();
        _selectedThreads.Clear();
        _selectedSpecs.Clear();
        _selectedDiameters.Clear();
        _selectedLengths.Clear();
        _searchString = "";
        Filter();
    }

    private Task<IEnumerable<string>> SearchTags(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_availableTags.Except(_tags));

        return Task.FromResult(_availableTags
            .Where(t => t.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Except(_tags));
    }

    private void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(_currentTag) && !_tags.Contains(_currentTag))
        {
            _tags.Add(_currentTag.Trim());
            if (!_availableTags.Contains(_currentTag))
                _availableTags.Add(_currentTag.Trim());
        }
        _currentTag = "";
    }

    private void RemoveTag(string tag)
    {
        _tags.Remove(tag);
    }

    private void AddToPending(ContractItemEditViewModel item)
    {
        var quantity = _quantities.GetValueOrDefault(item.Id, 1);

        // Check if item already in pending list
        var existing = _pendingItems.FirstOrDefault(p => p.ContractItemId == item.Id);
        if (existing != null)
        {
            existing.Quantity += quantity;
            Snackbar.Add($"Updated {item.CustomerStkNo} quantity to {existing.Quantity}", Severity.Info);
        }
        else
        {
            _pendingItems.Add(new PendingItem
            {
                ContractItemId = item.Id,
                CustomerStkNo = item.CustomerStkNo ?? "",
                Description = item.Description ?? "",
                Quantity = quantity
            });
            Snackbar.Add($"Added {item.CustomerStkNo} (qty: {quantity})", Severity.Success);
        }

        _quantities[item.Id] = 1; // Reset quantity
    }

    private void RemovePendingItem(PendingItem item)
    {
        _pendingItems.Remove(item);
    }

    private void ClearAllPendingItems()
    {
        _pendingItems.Clear();
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Create()
    {
        if (string.IsNullOrWhiteSpace(_name))
        {
            Snackbar.Add("Name is required", Severity.Warning);
            return;
        }

        _saving = true;

        var request = new CreateQuickOrderForUserRequest
        {
            Name = _name.Trim(),
            Tags = _tags,
            IsSharedClientWide = _isShared,
            Items = _pendingItems.Select(p => new QuickOrderItemRequest
            {
                ContractItemId = p.ContractItemId,
                Quantity = p.Quantity
            }).ToList()
        };

        var result = await QBSalesApi.CreateQuickOrderForUserAsync(UserId, request);

        if (result != null)
        {
            Snackbar.Add($"Created Quick Order '{_name}' with {_pendingItems.Count} items", Severity.Success);
            MudDialog.Close(DialogResult.Ok(result));
        }
        else
        {
            Snackbar.Add("Failed to create Quick Order", Severity.Error);
        }

        _saving = false;
    }

    private class PendingItem
    {
        public int ContractItemId { get; set; }
        public string CustomerStkNo { get; set; } = "";
        public string Description { get; set; } = "";
        public int Quantity { get; set; }
    }
}
