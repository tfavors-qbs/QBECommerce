@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Pages
@using QBExternalWebLibrary.Services.Http
@inject QBSalesQuickOrderApiService QBSalesApi

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">@(_detail?.QuickOrder?.Name ?? "Quick Order")</MudText>
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else if (_detail == null)
        {
            <MudAlert Severity="Severity.Error">Failed to load quick order</MudAlert>
        }
        else
        {
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField Value="@_detail.QuickOrder.Name"
                                  Label="Name"
                                  ReadOnly="true" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSwitch Value="@_detail.QuickOrder.IsSharedClientWide"
                               Label="Shared with organization"
                               Color="Color.Primary"
                               ReadOnly="true" />
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2">Tags</MudText>
                    <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mt-2">
                        @foreach (var tag in _detail.QuickOrder.Tags)
                        {
                            <MudChip T="string" Color="Color.Primary">@tag</MudChip>
                        }
                        @if (!_detail.QuickOrder.Tags.Any())
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary">No tags</MudText>
                        }
                    </MudStack>
                </MudItem>

                <MudItem xs="12">
                    <MudDivider Class="my-4" />
                    <MudText Typo="Typo.h6">Items (@_detail.Items.Count)</MudText>
                </MudItem>

                <MudItem xs="12">
                    @if (_detail.Items.Any())
                    {
                        <MudTable Items="_detail.Items" Dense="true" Hover="true">
                            <HeaderContent>
                                <MudTh>Stock Number</MudTh>
                                <MudTh>Description</MudTh>
                                <MudTh>Price</MudTh>
                                <MudTh>Quantity</MudTh>
                                <MudTh>Total</MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd Style="@(!context.IsAvailable ? "opacity: 0.5;" : "")">
                                    @context.ContractItem?.CustomerStkNo
                                    @if (!context.IsAvailable)
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Error">Unavailable</MudChip>
                                    }
                                </MudTd>
                                <MudTd Style="@(!context.IsAvailable ? "opacity: 0.5;" : "")">
                                    @context.ContractItem?.Description
                                </MudTd>
                                <MudTd Style="@(!context.IsAvailable ? "opacity: 0.5;" : "")">
                                    @(context.ContractItem?.Price.ToString("C") ?? "-")
                                </MudTd>
                                <MudTd>
                                    @context.Quantity
                                </MudTd>
                                <MudTd Style="@(!context.IsAvailable ? "opacity: 0.5;" : "")">
                                    @((context.Quantity * (context.ContractItem?.Price ?? 0)).ToString("C"))
                                </MudTd>
                            </RowTemplate>
                        </MudTable>

                        <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
                            <MudText>
                                <strong>Total:</strong> @_detail.Items.Where(i => i.IsAvailable).Sum(i => i.Quantity * (i.ContractItem?.Price ?? 0)).ToString("C")
                                (@_detail.Items.Count(i => i.IsAvailable) available items)
                            </MudText>
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">No items in this quick order.</MudAlert>
                    }
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public int QuickOrderId { get; set; }

    private bool _loading = true;
    private QuickOrderDetailEVM? _detail;

    protected override async Task OnInitializedAsync()
    {
        _detail = await QBSalesApi.GetByIdAsync(QuickOrderId);
        _loading = false;
    }

    private void Close() => MudDialog.Close();
}
