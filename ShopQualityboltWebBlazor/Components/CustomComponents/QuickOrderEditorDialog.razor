@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Pages
@using QBExternalWebLibrary.Services.Http
@inject QuickOrderApiService QuickOrderApi
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        @if (IsNew)
        {
            <MudText Typo="Typo.h6">Create Quick Order</MudText>
        }
        else if (IsReadOnly)
        {
            <MudText Typo="Typo.h6">@_detail?.QuickOrder?.Name</MudText>
        }
        else
        {
            <MudText Typo="Typo.h6">Edit Quick Order</MudText>
        }
    </TitleContent>
    <DialogContent>
        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else if (_detail == null && !IsNew)
        {
            <MudAlert Severity="Severity.Error">Failed to load quick order</MudAlert>
        }
        else
        {
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_name"
                                  Label="Name"
                                  Required="true"
                                  Disabled="@IsReadOnly" />
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudSwitch @bind-Value="_isShared"
                               Label="Share with organization"
                               Color="Color.Primary"
                               Disabled="@IsReadOnly" />
                </MudItem>
                <MudItem xs="12">
                    <MudAutocomplete T="string"
                                     Label="Tags"
                                     @bind-Value="_currentTag"
                                     SearchFunc="SearchTags"
                                     CoerceText="false"
                                     CoerceValue="false"
                                     Disabled="@IsReadOnly"
                                     Adornment="Adornment.End"
                                     AdornmentIcon="@Icons.Material.Filled.Add"
                                     OnAdornmentClick="AddTag" />
                    <MudStack Row="true" Wrap="Wrap.Wrap" Spacing="1" Class="mt-2">
                        @foreach (var tag in _tags)
                        {
                            <MudChip T="string" Color="Color.Primary"
                                     OnClose="@(() => RemoveTag(tag))"
                                     CloseIcon="@(IsReadOnly ? null : Icons.Material.Filled.Close)">
                                @tag
                            </MudChip>
                        }
                    </MudStack>
                </MudItem>

                @if (!IsNew)
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-4" />
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.h6">Items</MudText>
                            @if (!IsReadOnly)
                            {
                                <MudButton StartIcon="@Icons.Material.Filled.Add"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="OpenAddItemDialog">
                                    Add Items
                                </MudButton>
                            }
                        </MudStack>
                    </MudItem>

                    <MudItem xs="12">
                        @if (_items.Any())
                        {
                            <MudTable Items="_items" Dense="true" Hover="true">
                                <HeaderContent>
                                    <MudTh>
                                        @if (!IsReadOnly)
                                        {
                                            <MudCheckBox @bind-Value="_selectAll"
                                                         @bind-Value:after="ToggleSelectAll" />
                                        }
                                    </MudTh>
                                    <MudTh>Stock Number</MudTh>
                                    <MudTh>Description</MudTh>
                                    <MudTh>Price</MudTh>
                                    <MudTh>Quantity</MudTh>
                                    <MudTh>Total</MudTh>
                                    @if (!IsReadOnly)
                                    {
                                        <MudTh>Actions</MudTh>
                                    }
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd>
                                        @if (!IsReadOnly)
                                        {
                                            <MudCheckBox @bind-Value="@_selectedItems[context.Id]"
                                                         Disabled="@(!context.IsAvailable)" />
                                        }
                                    </MudTd>
                                    <MudTd Style="@(!context.IsAvailable ? "opacity: 0.5;" : "")">
                                        @context.ContractItem?.CustomerStkNo
                                        @if (!context.IsAvailable)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Error">Unavailable</MudChip>
                                        }
                                    </MudTd>
                                    <MudTd Style="@(!context.IsAvailable ? "opacity: 0.5;" : "")">
                                        @context.ContractItem?.Description
                                    </MudTd>
                                    <MudTd Style="@(!context.IsAvailable ? "opacity: 0.5;" : "")">
                                        @(context.ContractItem?.Price.ToString("C") ?? "-")
                                    </MudTd>
                                    <MudTd>
                                        @if (!IsReadOnly && context.IsAvailable)
                                        {
                                            <MudNumericField @bind-Value="context.Quantity"
                                                             @bind-Value:after="@(() => UpdateItemQuantity(context))"
                                                             Min="1"
                                                             Style="width: 80px;"
                                                             Variant="Variant.Outlined"
                                                             DebounceInterval="500" />
                                        }
                                        else
                                        {
                                            @context.Quantity
                                        }
                                    </MudTd>
                                    <MudTd Style="@(!context.IsAvailable ? "opacity: 0.5;" : "")">
                                        @((context.Quantity * (context.ContractItem?.Price ?? 0)).ToString("C"))
                                    </MudTd>
                                    @if (!IsReadOnly)
                                    {
                                        <MudTd>
                                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                           Size="Size.Small"
                                                           Color="Color.Error"
                                                           OnClick="@(() => RemoveItem(context))" />
                                        </MudTd>
                                    }
                                </RowTemplate>
                            </MudTable>

                            <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
                                <MudText>
                                    <strong>Total:</strong> @_items.Where(i => i.IsAvailable).Sum(i => i.Quantity * (i.ContractItem?.Price ?? 0)).ToString("C")
                                    (@_items.Count(i => i.IsAvailable) available items)
                                </MudText>
                            </MudStack>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">No items in this quick order.</MudAlert>
                        }
                    </MudItem>
                }
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        @if (!IsNew && !IsReadOnly)
        {
            <MudButton Color="Color.Success"
                       Variant="Variant.Filled"
                       OnClick="AddSelectedToCart"
                       Disabled="@(!_selectedItems.Any(x => x.Value))">
                Add Selected to Cart
            </MudButton>
            <MudButton Color="Color.Success"
                       OnClick="AddAllToCart">
                Add All to Cart
            </MudButton>
        }
        <MudSpacer />
        <MudButton OnClick="Cancel">@(IsReadOnly ? "Close" : "Cancel")</MudButton>
        @if (!IsReadOnly)
        {
            <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Save">Save</MudButton>
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; }

    [Parameter]
    public int QuickOrderId { get; set; }

    [Parameter]
    public bool IsNew { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; }

    private bool _loading = true;
    private QuickOrderDetailEVM? _detail;
    private string _name = "";
    private bool _isShared;
    private List<string> _tags = new();
    private string _currentTag = "";
    private List<QuickOrderItemEVM> _items = new();
    private Dictionary<int, bool> _selectedItems = new();
    private bool _selectAll;
    private List<string> _availableTags = new();

    protected override async Task OnInitializedAsync()
    {
        if (!IsNew)
        {
            _detail = await QuickOrderApi.GetByIdAsync(QuickOrderId);
            if (_detail != null)
            {
                _name = _detail.QuickOrder.Name;
                _isShared = _detail.QuickOrder.IsSharedClientWide;
                _tags = _detail.QuickOrder.Tags.ToList();
                _items = _detail.Items;
                _selectedItems = _items.ToDictionary(i => i.Id, _ => false);
                _availableTags = _detail.AvailableTags;
            }
        }
        else
        {
            _availableTags = await QuickOrderApi.GetTagsAsync();
        }
        _loading = false;
    }

    private Task<IEnumerable<string>> SearchTags(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value))
            return Task.FromResult(_availableTags.Except(_tags));

        return Task.FromResult(_availableTags
            .Where(t => t.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Except(_tags));
    }

    private void AddTag()
    {
        if (!string.IsNullOrWhiteSpace(_currentTag) && !_tags.Contains(_currentTag))
        {
            _tags.Add(_currentTag.Trim());
            if (!_availableTags.Contains(_currentTag))
                _availableTags.Add(_currentTag.Trim());
        }
        _currentTag = "";
    }

    private void RemoveTag(string tag)
    {
        _tags.Remove(tag);
    }

    private void ToggleSelectAll()
    {
        foreach (var item in _items.Where(i => i.IsAvailable))
        {
            _selectedItems[item.Id] = _selectAll;
        }
    }

    private async Task UpdateItemQuantity(QuickOrderItemEVM item)
    {
        if (item.Quantity < 1) item.Quantity = 1;
        await QuickOrderApi.UpdateItemAsync(QuickOrderId, item.Id, item.Quantity);
    }

    private async Task RemoveItem(QuickOrderItemEVM item)
    {
        var success = await QuickOrderApi.RemoveItemAsync(QuickOrderId, item.Id);
        if (success)
        {
            _items.Remove(item);
            _selectedItems.Remove(item.Id);
        }
    }

    private async Task OpenAddItemDialog()
    {
        // This would open a product search dialog
        // For now, show a placeholder message
        Snackbar.Add("Add items dialog - to be implemented", Severity.Info);
    }

    private async Task AddSelectedToCart()
    {
        var selectedIds = _selectedItems.Where(x => x.Value).Select(x => x.Key).ToList();
        if (!selectedIds.Any())
        {
            Snackbar.Add("No items selected", Severity.Warning);
            return;
        }

        var result = await QuickOrderApi.AddToCartAsync(QuickOrderId, selectedIds);
        if (result != null)
        {
            Snackbar.Add(result.Message, Severity.Success);
        }
    }

    private async Task AddAllToCart()
    {
        var result = await QuickOrderApi.AddToCartAsync(QuickOrderId);
        if (result != null)
        {
            Snackbar.Add(result.Message, Severity.Success);
        }
    }

    private void Cancel() => MudDialog.Cancel();

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(_name))
        {
            Snackbar.Add("Name is required", Severity.Warning);
            return;
        }

        _loading = true;

        if (IsNew)
        {
            var request = new CreateQuickOrderRequest
            {
                Name = _name,
                Tags = _tags,
                IsSharedClientWide = _isShared
            };
            var result = await QuickOrderApi.CreateAsync(request);
            if (result != null)
            {
                MudDialog.Close(DialogResult.Ok(result.Id));
            }
            else
            {
                Snackbar.Add("Failed to create quick order", Severity.Error);
            }
        }
        else
        {
            var request = new UpdateQuickOrderRequest
            {
                Name = _name,
                Tags = _tags,
                IsSharedClientWide = _isShared
            };
            var result = await QuickOrderApi.UpdateAsync(QuickOrderId, request);
            if (result != null)
            {
                MudDialog.Close(DialogResult.Ok(result.Id));
            }
            else
            {
                Snackbar.Add("Failed to update quick order", Severity.Error);
            }
        }

        _loading = false;
    }
}
