@using Microsoft.AspNetCore.Components
@inject IJSRuntime JSRuntime
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="mb-4">
            <strong>@Title</strong>
        </MudAlert>
        
        <MudText Typo="Typo.body1" Class="mb-4">
            @Message
        </MudText>
        
        @if (!string.IsNullOrEmpty(ResponseContent))
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Class="mb-4">
                <MudText Typo="Typo.subtitle2" Class="mb-2"><strong>Response from Ariba:</strong></MudText>
                <MudText Typo="Typo.body2" Style="font-family: monospace; white-space: pre-wrap; word-break: break-all;">
                    @ResponseContent.Substring(0, Math.Min(1000, ResponseContent.Length))
                    @if (ResponseContent.Length > 1000)
                    {
                        <text>... (truncated, see console for full response)</text>
                    }
                </MudText>
            </MudAlert>
        }
        
        <MudExpansionPanels>
            <MudExpansionPanel Text="Show Debug Information">
                <MudPaper Elevation="0" Class="pa-4" Style="background-color: #f5f5f5; max-height: 400px; overflow-y: auto;">
                    <MudText Typo="Typo.caption" Style="font-family: monospace; white-space: pre-wrap; font-size: 11px;">@DebugInfo</MudText>
                </MudPaper>
                <MudText Typo="Typo.caption" Class="mt-2" Color="Color.Secondary">
                    ?? Tip: This debug information is also logged to the browser console (press F12)
                </MudText>
            </MudExpansionPanel>
        </MudExpansionPanels>
        
        <MudDivider Class="my-4" />
        
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            <strong>What to do next:</strong>
        </MudText>
        <MudText Class="mt-2">
            • Try refreshing the page and attempting checkout again<br/>
            • Open browser console (F12) to see detailed logs<br/>
            • Contact support with the debug information above
        </MudText>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CopyDebugInfo" Color="Color.Secondary" Variant="Variant.Text">
            Copy Debug Info
        </MudButton>
        <MudButton OnClick="Close" Color="Color.Primary" Variant="Variant.Filled">
            Close
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    MudDialogInstance MudDialog { get; set; } = default!;
    
    [Parameter] 
    public string Title { get; set; } = "Error";
    
    [Parameter] 
    public string Message { get; set; } = "";
    
    [Parameter] 
    public string DebugInfo { get; set; } = "";
    
    [Parameter] 
    public string? ResponseContent { get; set; }
    
    private void Close() => MudDialog.Close(DialogResult.Ok(true));
    
    private async Task CopyDebugInfo()
    {
        var fullDebugInfo = $"=== PUNCHOUT CHECKOUT ERROR ===\nTitle: {Title}\nMessage: {Message}\nTimestamp: {DateTime.Now:yyyy-MM-dd HH:mm:ss}\n\n=== DEBUG LOG ===\n{DebugInfo}\n\n=== RESPONSE CONTENT ===\n{ResponseContent ?? "(No response content)"}";
        
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", fullDebugInfo);
            Snackbar.Add("Debug information copied to clipboard", Severity.Success);
        }
        catch
        {
            // Fallback if clipboard API not available
            await JSRuntime.InvokeVoidAsync("console.log", "Debug info (copy manually):", fullDebugInfo);
            Snackbar.Add("Debug information logged to console (F12)", Severity.Info);
        }
    }
}
