@using QBExternalWebLibrary.Models
@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Mapping
@using ShopQualityboltWebBlazor.Services
@inject ShoppingCartManagementService ShoppingCartManagementService;

<MudPaper Class="pa-4 mb-3" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="12" md="12" lg="9" xl="10">
            <MudStack Spacing="3">
                @* Header with Stock Number and Price *@
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        @if (Item?.ClassName?.Equals("Anchors", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <img src="/images/anchor.webp" alt="Anchor" style="width: 40px; height: 40px; object-fit: contain;" />
                        }
                        else if (Item?.ClassName?.Equals("Bolts", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <img src="/images/icons/bolt.png" alt="Bolt" style="width: 40px; height: 40px; object-fit: contain;" />
                        }
                        <MudStack Row="false" Spacing="0">
                            <MudText Typo="Typo.h6" Color="Color.Primary">@Item?.CustomerStkNo</MudText>
                            @if (!string.IsNullOrEmpty(Item?.SKUName))
                            {
                                <MudChip T="string" Text="@Item.SKUName" Size="Size.Small" Color="Color.Info" />
                            }
                        </MudStack>
                    </MudStack>
                    <MudText Typo="Typo.h5" Color="Color.Primary">@Item?.Price.ToString("C")</MudText>
                </MudStack>
                
                @* Description *@
                <MudText Typo="Typo.body1">@Item?.Description</MudText>
                
                @* Specifications with Icons *@
                <MudStack Row="true" Spacing="4" Wrap="Wrap.Wrap">
                    @if (!string.IsNullOrEmpty(Item?.ClassName) && Item.ClassName != "Uncategorized")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.body2"><strong>Class:</strong> @Item.ClassName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.GroupName) && Item.GroupName != "No Group")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2"><strong>Group:</strong> @Item.GroupName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.DiameterName) && Item.DiameterName != "No Diameter")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Tertiary" />
                            <MudText Typo="Typo.body2"><strong>Diameter:</strong> @Item.DiameterName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.LengthName) && Item.LengthName != "No Length")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Straighten" Size="Size.Small" Color="Color.Info" />
                            <MudText Typo="Typo.body2"><strong>Length:</strong> @Item.LengthName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.MaterialName) && Item.MaterialName != "No Material")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.body2"><strong>Material:</strong> @Item.MaterialName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.CoatingName) && Item.CoatingName != "No Coating")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Brush" Size="Size.Small" Color="Color.Warning" />
                            <MudText Typo="Typo.body2"><strong>Coating:</strong> @Item.CoatingName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.ThreadName) && Item.ThreadName != "No Thread")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" Color="Color.Error" />
                            <MudText Typo="Typo.body2"><strong>Thread:</strong> @Item.ThreadName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.ShapeName) && Item.ShapeName != "No Shape")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Architecture" Size="Size.Small" Color="Color.Dark" />
                            <MudText Typo="Typo.body2"><strong>Shape:</strong> @Item.ShapeName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.SpecName) && Item.SpecName != "No Spec")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Color="Color.Default" />
                            <MudText Typo="Typo.body2"><strong>Spec:</strong> @Item.SpecName</MudText>
                        </MudStack>
                    }
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="12" md="12" lg="3" xl="2">
            <MudStack Spacing="2" Justify="Justify.Center" Style="height: 100%;">
                <MudNumericField Disabled="IsReadOnly" 
                                Min="@(_isExistingItemInCart ? 0 : 1)" 
                                Variant="Variant.Outlined" 
                                @bind-Value="@OrderQuantity"
                                Label="Quantity"></MudNumericField>
                <MudButton Disabled="_isSameQtyAsCart || IsReadOnly" 
                          StartIcon="@Icons.Material.TwoTone.AddShoppingCart" 
                          Variant="Variant.Filled" 
                          Color="@(_isExistingItemInCart ? OrderQuantity == 0 ? Color.Error : Color.Warning : Color.Primary)" 
                          OnClick="UpdateItemToCart"
                          FullWidth="true">
                    @_editButtonText
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    [Parameter]
    public int OrderQuantity { get; set; } = 1;

    [Parameter]
    public ContractItemEditViewModel Item { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; }

    private bool _isSameQtyAsCart => _isExistingItemInCart && ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs[Item.Id].Quantity == OrderQuantity;
    private bool _isExistingItemInCart => ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs.ContainsKey(Item.Id) ?? false;
    private string _editButtonText => _isExistingItemInCart ? OrderQuantity == 0 ? "Remove From Cart" : "Update In Cart" : "Add To Cart";

    private async Task UpdateItemToCart()
    {
        if (_isExistingItemInCart)
        {
            var cartItem = ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs[Item.Id].Copy();
            if(OrderQuantity == 0)
            {
                await ShoppingCartManagementService.DeleteItemAsync(cartItem);
            }
            else
            {
                cartItem.Quantity = OrderQuantity;
                await ShoppingCartManagementService.UpdateItemAsync(cartItem);
            }
        }
        else
        {
            var cartItem = ShoppingCartItemMapper.MapToEdit(Item, ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartEVM.Id, OrderQuantity);
            await ShoppingCartManagementService.AddItemAsync(cartItem);
        }
    }
}
