@using QBExternalWebLibrary.Models
@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Mapping
@using ShopQualityboltWebBlazor.Services
@inject ShoppingCartManagementService ShoppingCartManagementService;

<MudPaper Class="pa-4 mb-3" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="12" md="12" lg="9" xl="10">
            <MudStack Spacing="3">
                @* Header with Stock Number and Price *@
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        @if (Item?.ClassName?.Equals("Anchors", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <div class="anchor-icon">
                                <div class="anchor-ring"></div>
                                <div class="anchor-shank"></div>
                                <div class="anchor-flukes"></div>
                            </div>
                        }
                        else if (Item?.ClassName?.Equals("Bolts", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <div class="bolt-icon">
                                <div class="bolt-head"></div>
                                <div class="bolt-shaft"></div>
                                <div class="bolt-threads"></div>
                            </div>
                        }
                        else if (Item?.ClassName?.Equals("Nuts", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <div class="nut-icon">
                                <div class="nut-hexagon">
                                    <div class="nut-hole"></div>
                                    <div class="nut-threads"></div>
                                </div>
                            </div>
                        }
                        else if (Item?.ClassName?.Equals("Screws", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <div class="screw-icon">
                                <div class="screw-head"></div>
                                <div class="screw-shaft"></div>
                                <div class="screw-threads"></div>
                                <div class="screw-point"></div>
                            </div>
                        }
                        else if (Item?.ClassName?.Equals("Rod", StringComparison.OrdinalIgnoreCase) == true || Item?.ClassName?.Equals("Rods", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <div class="rod-icon">
                                <div class="rod-body"></div>
                            </div>
                        }
                        else if (Item?.ClassName?.Equals("Washers", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <div class="washer-icon">
                                <div class="washer-ring"></div>
                            </div>
                        }
                        <MudStack Row="false" Spacing="0">
                            <MudText Typo="Typo.h6" Color="Color.Primary">@Item?.CustomerStkNo</MudText>
                            @if (!string.IsNullOrEmpty(Item?.SKUName))
                            {
                                <MudChip T="string" Text="@Item.SKUName" Size="Size.Small" Color="Color.Info" />
                            }
                        </MudStack>
                    </MudStack>
                    <MudText Typo="Typo.h5" Color="Color.Primary">@Item?.Price.ToString("C")</MudText>
                </MudStack>
                
                @* Description *@
                <MudText Typo="Typo.body1">@Item?.Description</MudText>
                
                @* Specifications with Icons *@
                <MudStack Row="true" Spacing="4" Wrap="Wrap.Wrap">
                    @if (!string.IsNullOrEmpty(Item?.ClassName) && Item.ClassName != "Uncategorized")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.body2"><strong>Class:</strong> @Item.ClassName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.GroupName) && Item.GroupName != "No Group")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2"><strong>Group:</strong> @Item.GroupName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.DiameterName) && Item.DiameterName != "No Diameter")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Tertiary" />
                            <MudText Typo="Typo.body2"><strong>Diameter:</strong> @Item.DiameterName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.LengthName) && Item.LengthName != "No Length")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Straighten" Size="Size.Small" Color="Color.Info" />
                            <MudText Typo="Typo.body2"><strong>Length:</strong> @Item.LengthName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.MaterialName) && Item.MaterialName != "No Material")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.body2"><strong>Material:</strong> @Item.MaterialName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.CoatingName) && Item.CoatingName != "No Coating")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Brush" Size="Size.Small" Color="Color.Warning" />
                            <MudText Typo="Typo.body2"><strong>Coating:</strong> @Item.CoatingName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.ThreadName) && Item.ThreadName != "No Thread")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" Color="Color.Error" />
                            <MudText Typo="Typo.body2"><strong>Thread:</strong> @Item.ThreadName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.ShapeName) && Item.ShapeName != "No Shape")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Architecture" Size="Size.Small" Color="Color.Dark" />
                            <MudText Typo="Typo.body2"><strong>Shape:</strong> @Item.ShapeName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.SpecName) && Item.SpecName != "No Spec")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Color="Color.Default" />
                            <MudText Typo="Typo.body2"><strong>Spec:</strong> @Item.SpecName</MudText>
                        </MudStack>
                    }
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="12" md="12" lg="3" xl="2">
            <MudStack Spacing="2" Justify="Justify.Center" Style="height: 100%;">
                <MudNumericField Disabled="IsReadOnly" 
                                Min="@(_isExistingItemInCart ? 0 : 1)" 
                                Variant="Variant.Outlined" 
                                @bind-Value="@OrderQuantity"
                                Label="Quantity"></MudNumericField>
                <MudButton Disabled="_isSameQtyAsCart || IsReadOnly" 
                          StartIcon="@Icons.Material.TwoTone.AddShoppingCart" 
                          Variant="Variant.Filled" 
                          Color="@(_isExistingItemInCart ? OrderQuantity == 0 ? Color.Error : Color.Warning : Color.Primary)" 
                          OnClick="UpdateItemToCart"
                          FullWidth="true">
                    @_editButtonText
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    [Parameter]
    public int OrderQuantity { get; set; } = 1;

    [Parameter]
    public ContractItemEditViewModel Item { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; }

    private bool _isSameQtyAsCart => _isExistingItemInCart && ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs[Item.Id].Quantity == OrderQuantity;
    private bool _isExistingItemInCart => ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs.ContainsKey(Item.Id) ?? false;
    private string _editButtonText => _isExistingItemInCart ? OrderQuantity == 0 ? "Remove From Cart" : "Update In Cart" : "Add To Cart";

    private async Task UpdateItemToCart()
    {
        if (_isExistingItemInCart)
        {
            var cartItem = ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs[Item.Id].Copy();
            if(OrderQuantity == 0)
            {
                await ShoppingCartManagementService.DeleteItemAsync(cartItem);
            }
            else
            {
                cartItem.Quantity = OrderQuantity;
                await ShoppingCartManagementService.UpdateItemAsync(cartItem);
            }
        }
        else
        {
            var cartItem = ShoppingCartItemMapper.MapToEdit(Item, ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartEVM.Id, OrderQuantity);
            await ShoppingCartManagementService.AddItemAsync(cartItem);
        }
    }
}

<style>
    .anchor-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 4px;
        transition: transform 0.3s ease;
    }

    .anchor-icon:hover {
        transform: scale(1.1);
    }

    .anchor-icon:hover .anchor-ring {
        animation: bolt-rotate 0.6s ease-in-out;
    }

    .anchor-icon:hover .anchor-flukes::before,
    .anchor-icon:hover .anchor-flukes::after {
        animation: expand-wings 0.5s ease-out forwards;
    }

    .anchor-ring {
        width: 27px;
        height: 9px;
        background: var(--mud-palette-primary);
        border-radius: 4px 4px 0 0;
        position: relative;
    }

    .anchor-ring::before {
        content: '';
        position: absolute;
        top: 2px;
        left: 50%;
        transform: translateX(-50%);
        width: 9px;
        height: 4px;
        border: 3px solid var(--mud-palette-primary);
        border-bottom: none;
        border-radius: 50% 50% 0 0;
        background: transparent;
    }

    .anchor-shank {
        width: 12px;
        height: 27px;
        background: linear-gradient(to right, 
            var(--mud-palette-primary) 0%, 
            #4A9AB8 50%, 
            var(--mud-palette-primary) 100%);
        margin-top: 1px;
    }

    .anchor-flukes {
        width: 30px;
        height: 12px;
        background: repeating-linear-gradient(
            to bottom,
            var(--mud-palette-primary) 0px,
            var(--mud-palette-primary) 1.5px,
            transparent 1.5px,
            transparent 3px
        );
        border-radius: 0 0 3px 3px;
        margin-top: 1px;
        position: relative;
    }

    .anchor-flukes::before,
    .anchor-flukes::after {
        content: '';
        position: absolute;
        bottom: -6px;
        width: 0;
        height: 0;
        border-style: solid;
    }

    .anchor-flukes::before {
        left: 0px;
        border-width: 12px 0 0 12px;
        border-color: transparent transparent transparent var(--mud-palette-primary);
    }

    .anchor-flukes::after {
        right: 0px;
        border-width: 12px 12px 0 0;
        border-color: transparent var(--mud-palette-primary) transparent transparent;
    }

    @@keyframes bolt-rotate {
        0%, 100% { transform: rotateY(0deg); }
        25% { transform: rotateY(-8deg); }
        75% { transform: rotateY(8deg); }
    }

    @@keyframes expand-wings {
        0% { transform: translateX(0); }
        50% { transform: translateX(0) scale(1.2); }
        100% { transform: translateX(0); }
    }

    @@keyframes bolt-tighten {
        0%, 100% { transform: rotateY(0deg); }
        25% { transform: rotateY(-8deg); }
        75% { transform: rotateY(8deg); }
    }

    @@keyframes thread-spin {
        0% { background-position: 0 0; }
        100% { background-position: 0 2px; }
    }

    .bolt-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 7px;
        transition: transform 0.3s ease;
    }

    .bolt-icon:hover {
        transform: scale(1.1);
    }

    .bolt-icon:hover .bolt-head {
        animation: bolt-tighten 0.8s ease-in-out;
    }

    .bolt-icon:hover .bolt-threads {
        animation: thread-spin 1s linear infinite;
    }

    .bolt-head {
        width: 30px;
        height: 12px;
        background: var(--mud-palette-primary);
        border-radius: 3px;
        position: relative;
    }

    .bolt-head::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 15px;
        height: 3px;
        background: rgba(255, 255, 255, 0.3);
    }

    .bolt-shaft {
        width: 12px;
        height: 27px;
        background: linear-gradient(to right, 
            var(--mud-palette-primary) 0%, 
            #4A9AB8 50%, 
            var(--mud-palette-primary) 100%);
        margin-top: 1px;
    }

    .bolt-threads {
        width: 18px;
        height: 12px;
        background: repeating-linear-gradient(
            to bottom,
            var(--mud-palette-primary) 0px,
            var(--mud-palette-primary) 1.5px,
            transparent 1.5px,
            transparent 3px
        );
        margin-top: 1px;
    }

    .nut-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
    }

    .nut-icon:hover {
        transform: scale(1.1);
    }

    .nut-icon:hover .nut-hexagon {
        animation: nut-tighten 1.2s linear infinite;
    }



    .nut-hexagon {
        position: relative;
        width: 48px;
        height: 30px;
        background: linear-gradient(to right,
            var(--mud-palette-primary) 0%,
            #558FA8 15%,
            var(--mud-palette-primary) 50%,
            #558FA8 85%,
            var(--mud-palette-primary) 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        clip-path: polygon(25% 0%, 75% 0%, 100% 15%, 100% 85%, 75% 100%, 25% 100%, 0% 85%, 0% 15%);
    }

    .nut-hexagon::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 15%;
        background: linear-gradient(to bottom, 
            rgba(255, 255, 255, 0.5) 0%,
            transparent 100%);
    }

    .nut-hexagon::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 15%;
        background: linear-gradient(to top, 
            rgba(0, 0, 0, 0.15) 0%,
            transparent 100%);
    }

    .nut-hole {
        display: none;
    }

    .nut-threads {
        display: none;
    }

    @@keyframes nut-tighten {
        0%, 100% { transform: rotateY(0deg); }
        25% { transform: rotateY(-8deg); }
        75% { transform: rotateY(8deg); }
    }

    @@keyframes thread-scroll {
        0% { background-position: 0 0; }
        100% { background-position: 0 2px; }
    }

    .screw-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 7px;
        transition: transform 0.3s ease;
    }

    .screw-icon:hover {
        transform: scale(1.1);
    }

    .screw-icon:hover .screw-head {
        animation: screw-tighten 0.8s ease-in-out;
    }

    .screw-icon:hover .screw-threads {
        animation: thread-spin 1s linear infinite;
    }

    .screw-head {
        width: 24px;
        height: 8px;
        background: var(--mud-palette-primary);
        border-radius: 12px 12px 0 0;
        position: relative;
    }

    .screw-head::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 12px;
        height: 2px;
        background: rgba(255, 255, 255, 0.3);
    }

    .screw-shaft {
        width: 9px;
        height: 20px;
        background: linear-gradient(to right, 
            var(--mud-palette-primary) 0%, 
            #4A9AB8 50%, 
            var(--mud-palette-primary) 100%);
        margin-top: 0px;
    }

    .screw-threads {
        width: 14px;
        height: 12px;
        background: repeating-linear-gradient(
            to bottom,
            var(--mud-palette-primary) 0px,
            var(--mud-palette-primary) 1.5px,
            transparent 1.5px,
            transparent 3px
        );
        margin-top: 0px;
    }

    .screw-point {
        width: 0;
        height: 0;
        border-left: 7px solid transparent;
        border-right: 7px solid transparent;
        border-top: 6px solid var(--mud-palette-primary);
        margin-top: 0px;
    }

    @@keyframes screw-tighten {
        0%, 100% { transform: rotateY(0deg); }
        25% { transform: rotateY(-8deg); }
        75% { transform: rotateY(8deg); }
    }

    .rod-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
    }

    .rod-icon:hover {
        transform: scale(1.1);
    }

    .rod-icon:hover .rod-body {
        animation: rod-tighten 0.8s ease-in-out;
    }

    .rod-body {
        width: 50px;
        height: 16px;
        background: repeating-linear-gradient(
            to right,
            var(--mud-palette-primary) 0px,
            var(--mud-palette-primary) 3px,
            #4A9AB8 3px,
            #4A9AB8 4px,
            var(--mud-palette-primary) 4px,
            var(--mud-palette-primary) 7px
        );
        border-radius: 8px;
        position: relative;
    }

    .rod-body::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 50%;
        background: linear-gradient(to bottom,
            rgba(255, 255, 255, 0.2) 0%,
            transparent 100%);
        border-radius: 8px 8px 0 0;
    }

    @@keyframes rod-tighten {
        0%, 100% { transform: rotateY(0deg); }
        25% { transform: rotateY(-8deg); }
        75% { transform: rotateY(8deg); }
    }

    .washer-icon {
        position: relative;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: transform 0.3s ease;
        perspective: 200px;
    }

    .washer-icon:hover {
        transform: scale(1.1);
    }

    .washer-icon:hover .washer-ring {
        animation: washer-wobble 1s ease-in-out infinite;
    }

    .washer-ring {
        width: 40px;
        height: 30px;
        border: 4px solid var(--mud-palette-primary);
        border-radius: 50%;
        position: relative;
        transform: rotateX(60deg);
        background: linear-gradient(to bottom,
            rgba(94, 163, 189, 0.3) 0%,
            rgba(94, 163, 189, 0.6) 50%,
            rgba(94, 163, 189, 0.3) 100%);
    }

    .washer-ring::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 16px;
        height: 12px;
        border: 3px solid var(--mud-palette-primary);
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.4);
    }

    @@keyframes washer-wobble {
        0%, 100% { transform: rotateX(60deg) rotateZ(0deg); }
        25% { transform: rotateX(60deg) rotateZ(-10deg); }
        75% { transform: rotateX(60deg) rotateZ(10deg); }
    }
</style>
