@using QBExternalWebLibrary.Models
@using QBExternalWebLibrary.Models.Catalog
@using QBExternalWebLibrary.Models.Mapping
@using ShopQualityboltWebBlazor.Services
@inject ShoppingCartManagementService ShoppingCartManagementService;

<MudPaper Class="pa-4 mb-3" Elevation="2">
    <MudGrid>
        <MudItem xs="12" sm="12" md="12" lg="9" xl="10">
            <MudStack Spacing="3">
                @* Header with Stock Number and Price *@
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        @if (Item?.ClassName?.Equals("Anchors", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <div class="anchor-icon">
                                <div class="anchor-ring"></div>
                                <div class="anchor-shank"></div>
                                <div class="anchor-flukes"></div>
                            </div>
                        }
                        else if (Item?.ClassName?.Equals("Bolts", StringComparison.OrdinalIgnoreCase) == true)
                        {
                            <div class="bolt-icon">
                                <div class="bolt-head"></div>
                                <div class="bolt-shaft"></div>
                                <div class="bolt-threads"></div>
                            </div>
                        }
                        <MudStack Row="false" Spacing="0">
                            <MudText Typo="Typo.h6" Color="Color.Primary">@Item?.CustomerStkNo</MudText>
                            @if (!string.IsNullOrEmpty(Item?.SKUName))
                            {
                                <MudChip T="string" Text="@Item.SKUName" Size="Size.Small" Color="Color.Info" />
                            }
                        </MudStack>
                    </MudStack>
                    <MudText Typo="Typo.h5" Color="Color.Primary">@Item?.Price.ToString("C")</MudText>
                </MudStack>
                
                @* Description *@
                <MudText Typo="Typo.body1">@Item?.Description</MudText>
                
                @* Specifications with Icons *@
                <MudStack Row="true" Spacing="4" Wrap="Wrap.Wrap">
                    @if (!string.IsNullOrEmpty(Item?.ClassName) && Item.ClassName != "Uncategorized")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.body2"><strong>Class:</strong> @Item.ClassName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.GroupName) && Item.GroupName != "No Group")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Inventory" Size="Size.Small" Color="Color.Secondary" />
                            <MudText Typo="Typo.body2"><strong>Group:</strong> @Item.GroupName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.DiameterName) && Item.DiameterName != "No Diameter")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Circle" Size="Size.Small" Color="Color.Tertiary" />
                            <MudText Typo="Typo.body2"><strong>Diameter:</strong> @Item.DiameterName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.LengthName) && Item.LengthName != "No Length")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Straighten" Size="Size.Small" Color="Color.Info" />
                            <MudText Typo="Typo.body2"><strong>Length:</strong> @Item.LengthName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.MaterialName) && Item.MaterialName != "No Material")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Science" Size="Size.Small" Color="Color.Success" />
                            <MudText Typo="Typo.body2"><strong>Material:</strong> @Item.MaterialName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.CoatingName) && Item.CoatingName != "No Coating")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Brush" Size="Size.Small" Color="Color.Warning" />
                            <MudText Typo="Typo.body2"><strong>Coating:</strong> @Item.CoatingName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.ThreadName) && Item.ThreadName != "No Thread")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" Color="Color.Error" />
                            <MudText Typo="Typo.body2"><strong>Thread:</strong> @Item.ThreadName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.ShapeName) && Item.ShapeName != "No Shape")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Architecture" Size="Size.Small" Color="Color.Dark" />
                            <MudText Typo="Typo.body2"><strong>Shape:</strong> @Item.ShapeName</MudText>
                        </MudStack>
                    }
                    @if (!string.IsNullOrEmpty(Item?.SpecName) && Item.SpecName != "No Spec")
                    {
                        <MudStack Row="true" Spacing="1" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.Description" Size="Size.Small" Color="Color.Default" />
                            <MudText Typo="Typo.body2"><strong>Spec:</strong> @Item.SpecName</MudText>
                        </MudStack>
                    }
                </MudStack>
            </MudStack>
        </MudItem>
        <MudItem xs="12" sm="12" md="12" lg="3" xl="2">
            <MudStack Spacing="2" Justify="Justify.Center" Style="height: 100%;">
                <MudNumericField Disabled="IsReadOnly" 
                                Min="@(_isExistingItemInCart ? 0 : 1)" 
                                Variant="Variant.Outlined" 
                                @bind-Value="@OrderQuantity"
                                Label="Quantity"></MudNumericField>
                <MudButton Disabled="_isSameQtyAsCart || IsReadOnly" 
                          StartIcon="@Icons.Material.TwoTone.AddShoppingCart" 
                          Variant="Variant.Filled" 
                          Color="@(_isExistingItemInCart ? OrderQuantity == 0 ? Color.Error : Color.Warning : Color.Primary)" 
                          OnClick="UpdateItemToCart"
                          FullWidth="true">
                    @_editButtonText
                </MudButton>
            </MudStack>
        </MudItem>
    </MudGrid>
</MudPaper>

@code {
    [Parameter]
    public int OrderQuantity { get; set; } = 1;

    [Parameter]
    public ContractItemEditViewModel Item { get; set; }

    [Parameter]
    public bool IsReadOnly { get; set; }

    private bool _isSameQtyAsCart => _isExistingItemInCart && ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs[Item.Id].Quantity == OrderQuantity;
    private bool _isExistingItemInCart => ShoppingCartManagementService.UsersShoppingCartEVM?.ShoppingCartItemEVMs.ContainsKey(Item.Id) ?? false;
    private string _editButtonText => _isExistingItemInCart ? OrderQuantity == 0 ? "Remove From Cart" : "Update In Cart" : "Add To Cart";

    private async Task UpdateItemToCart()
    {
        if (_isExistingItemInCart)
        {
            var cartItem = ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartItemEVMs[Item.Id].Copy();
            if(OrderQuantity == 0)
            {
                await ShoppingCartManagementService.DeleteItemAsync(cartItem);
            }
            else
            {
                cartItem.Quantity = OrderQuantity;
                await ShoppingCartManagementService.UpdateItemAsync(cartItem);
            }
        }
        else
        {
            var cartItem = ShoppingCartItemMapper.MapToEdit(Item, ShoppingCartManagementService.UsersShoppingCartEVM.ShoppingCartEVM.Id, OrderQuantity);
            await ShoppingCartManagementService.AddItemAsync(cartItem);
        }
    }
}

<style>
    .anchor-icon {
        position: relative;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .anchor-ring {
        position: absolute;
        top: 2px;
        width: 14px;
        height: 14px;
        border: 3px solid var(--mud-palette-primary);
        border-radius: 50%;
    }

    .anchor-shank {
        position: absolute;
        top: 10px;
        width: 3px;
        height: 20px;
        background: var(--mud-palette-primary);
    }

    .anchor-flukes {
        position: absolute;
        bottom: 5px;
        width: 24px;
        height: 12px;
        background: linear-gradient(to bottom, transparent 0%, transparent 40%, var(--mud-palette-primary) 40%, var(--mud-palette-primary) 60%, transparent 60%);
    }

    .anchor-flukes::before,
    .anchor-flukes::after {
        content: '';
        position: absolute;
        width: 0;
        height: 0;
        border-style: solid;
    }

    .anchor-flukes::before {
        left: -6px;
        bottom: -3px;
        border-width: 0 12px 15px 0;
        border-color: transparent var(--mud-palette-primary) transparent transparent;
    }

    .anchor-flukes::after {
        right: -6px;
        bottom: -3px;
        border-width: 0 0 15px 12px;
        border-color: transparent transparent transparent var(--mud-palette-primary);
    }

    .bolt-icon {
        position: relative;
        width: 40px;
        height: 40px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding-top: 5px;
    }

    .bolt-head {
        width: 20px;
        height: 8px;
        background: var(--mud-palette-primary);
        border-radius: 2px;
        position: relative;
    }

    .bolt-head::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 10px;
        height: 2px;
        background: rgba(255, 255, 255, 0.3);
    }

    .bolt-shaft {
        width: 8px;
        height: 18px;
        background: linear-gradient(to right, 
            var(--mud-palette-primary) 0%, 
            #4A9AB8 50%, 
            var(--mud-palette-primary) 100%);
        margin-top: 1px;
    }

    .bolt-threads {
        width: 12px;
        height: 8px;
        background: repeating-linear-gradient(
            to bottom,
            var(--mud-palette-primary) 0px,
            var(--mud-palette-primary) 1px,
            transparent 1px,
            transparent 2px
        );
        margin-top: 1px;
    }
</style>
