# HttpClient Architecture - Visual Guide

## ?? **Before (Broken) vs After (Fixed)**

### ? **BEFORE - Multiple Confusing Clients**
```
???????????????????????????????????????????????????????????????
? Program.cs (Confusing Configuration)                        ?
???????????????????????????????????????????????????????????????
?                                                              ?
?  AddScoped(sp => new HttpClient()) ????                     ?
?     ? No token handler!               ?                     ?
?                                        ?                     ?
?  AddHttpClient("Auth")                 ?                     ?
?     ? Has token handler                ?                     ?
?                                        ?                     ?
?  AddScoped(sp => new HttpClient()) ????                     ?
?     ? Different base address          ?                     ?
?                                        ?                     ?
????????????????????????????????????????????????????????????????
                                         ?
                    ?????????????????????????????????????????
                    ?                                        ?
                    ?                                        ?
            Components use                           Auth provider uses
            default client                           "Auth" client
                    ?                                        ?
                    ?                                        ?
            ? No token sent!                        ? Token sent
            401 Unauthorized                         Works correctly
```

### ? **AFTER - Single Clean Configuration**
```
???????????????????????????????????????????????????????????????
? Program.cs (Clean Configuration)                            ?
???????????????????????????????????????????????????????????????
?                                                              ?
?  AddScoped<ITokenService, TokenService>()                   ?
?  AddScoped<JwtTokenHandler>()                               ?
?  AddTransient<CookieHandler>()                              ?
?                                                              ?
?  AddHttpClient<HttpClient>() ???????                        ?
?     .AddHttpMessageHandler<Cookie> ?  Both use               ?
?     .AddHttpMessageHandler<Jwt>    ?  same handlers!        ?
?                                    ?                         ?
?  AddHttpClient("Auth") ?????????????                        ?
?     .AddHttpMessageHandler<Cookie> ?                        ?
?     .AddHttpMessageHandler<Jwt> ????                        ?
?                                                              ?
????????????????????????????????????????????????????????????????
                    ?
                    ?  Same configuration
                    ?
        ????????????????????????
        ?                      ?
        ?                      ?
    All components         Auth provider
    use HttpClient        uses "Auth"
        ?                      ?
        ?                      ?
    ? Token sent!         ? Token sent!
    Works correctly       Works correctly
```

---

## ?? **Complete Request Flow**

```
????????????????????????????????????????????????????????????????????
?  1. User Action (e.g., Load Catalog Page)                        ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  2. Component Code                                                ?
?                                                                   ?
?     var products = await Http.GetFromJsonAsync<List<Product>>(   ?
?         "api/products"                                            ?
?     );                                                            ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  3. HttpClient (Injected from DI)                                ?
?     - BaseAddress: https://localhost:7237                        ?
?     - Handlers: [CookieHandler, JwtTokenHandler]                 ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  4. CookieHandler.SendAsync()                                    ?
?     - Manages cookies (if needed)                                ?
?     - Passes request to next handler                             ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  5. JwtTokenHandler.SendAsync()                                  ?
?     ??????????????????????????????????????????????????????????  ?
?     ? var token = await TokenService.GetTokenAsync();        ?  ?
?     ? if (token != null)                                     ?  ?
?     ?     request.Headers.Authorization =                    ?  ?
?     ?         new AuthenticationHeaderValue("Bearer", token);?  ?
?     ??????????????????????????????????????????????????????????  ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  6. HTTP Request to API                                           ?
?                                                                   ?
?     GET https://localhost:7237/api/products                      ?
?     Headers:                                                     ?
?         Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6...   ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  7. API Server (ShopQualityboltWeb)                              ?
?     - JWT middleware validates token                             ?
?     - StaleClaimsMiddleware checks LastModified                  ?
?     - If stale, generates new token                              ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  8. HTTP Response                                                 ?
?                                                                   ?
?     200 OK                                                       ?
?     Headers:                                                     ?
?         X-Token-Refreshed: true  (if token was refreshed)        ?
?         X-Token-Refresh: eyJhbGc... (new token)                  ?
?     Body:                                                        ?
?         [{ "id": 1, "name": "Product 1" }, ...]                 ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  9. JwtTokenHandler.SendAsync() (after response received)        ?
?     ??????????????????????????????????????????????????????????  ?
?     ? if (response.Headers.Contains("X-Token-Refreshed"))    ?  ?
?     ? {                                                      ?  ?
?     ?     var newToken = response.Headers                    ?  ?
?     ?         .GetValues("X-Token-Refresh").First();        ?  ?
?     ?     await TokenService.SetTokenAsync(newToken);        ?  ?
?     ? }                                                      ?  ?
?     ??????????????????????????????????????????????????????????  ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  10. TokenService.SetTokenAsync()                                ?
?      ?????????????????????????????????????????????????????????  ?
?      ? _token = newToken;                                    ?  ?
?      ? OnTokenChanged?.Invoke(newToken);                     ?  ?
?      ?????????????????????????????????????????????????????????  ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  11. CookieAuthenticationStateProvider (Event Handler)           ?
?      ?????????????????????????????????????????????????????????  ?
?      ? private void OnTokenChanged(string? newToken)         ?  ?
?      ? {                                                     ?  ?
?      ?     NotifyAuthenticationStateChanged(                 ?  ?
?      ?         GetAuthenticationStateAsync()                 ?  ?
?      ?     );                                                ?  ?
?      ? }                                                     ?  ?
?      ?????????????????????????????????????????????????????????  ?
????????????????????????????????????????????????????????????????????
                            ?
????????????????????????????????????????????????????????????????????
?  12. Blazor Component Re-renders                                 ?
?      - AuthorizeView components refresh                          ?
?      - User sees updated data with new client name               ?
?      - All claims are now current                                ?
????????????????????????????????????????????????????????????????????
```

---

## ?? **User Journey Scenarios**

### **Scenario 1: First Login**
```
User clicks "Login"
    ?
Login component calls CookieAuthenticationStateProvider.LoginAsync()
    ?
POST to api/accounts/login
    ?
Server generates JWT with user claims
    ?
Response: { "accessToken": "eyJ..." }
    ?
TokenService.SetTokenAsync(token)
    ?
OnTokenChanged event fires
    ?
UI updates: User is now authenticated
    ?
User navigates to Catalog
    ?
Catalog loads products using HttpClient
    ?
JwtTokenHandler adds token to request
    ?
? Products load successfully!
```

### **Scenario 2: Admin Changes User's Client**
```
User is viewing Catalog (shows "Client A")
    ?
Admin changes user's ClientId in database
    ?
Admin updates user.LastModified timestamp
    ?
User clicks "Refresh" on Catalog page
    ?
HttpClient.GetAsync("api/products")
    ?
JwtTokenHandler adds current token
    ?
Request sent to API
    ?
StaleClaimsMiddleware checks token's UserModifiedAt
    ?
Middleware compares with user.LastModified in DB
    ?
STALE! UserModifiedAt < LastModified
    ?
Middleware generates new token with updated ClientId claim
    ?
Response includes X-Token-Refreshed: true
    ?
JwtTokenHandler receives response
    ?
JwtTokenHandler saves new token
    ?
OnTokenChanged event fires
    ?
CookieAuthenticationStateProvider refreshes auth state
    ?
Blazor re-renders components
    ?
? Catalog now shows "Client B"!
```

### **Scenario 3: Multiple Tabs (Different Users)**
```
Tab 1: User A logs in
    ?
TokenService (Circuit 1) stores User A's token
    ?
Tab 2: User B logs in (same browser, different tab/incognito)
    ?
TokenService (Circuit 2) stores User B's token
    ?
Tab 1 makes API request
    ?
Uses Circuit 1's TokenService ? User A's token
    ?
? Gets User A's data
    ?
Tab 2 makes API request
    ?
Uses Circuit 2's TokenService ? User B's token
    ?
? Gets User B's data
    ?
NO INTERFERENCE! Each circuit is isolated.
```

---

## ?? **Token Lifecycle**

```
???????????????????????????????????????????????????????????????
?  Token States & Transitions                                  ?
???????????????????????????????????????????????????????????????

    [No Token]
        ?
        ? User logs in
        ?
    [Token Stored in Memory]
        ?
        ??? Every API request includes this token
        ?
        ? User navigates between pages
        ??? Token persists (same circuit)
        ?
        ? Server detects stale claims
        ?
    [Token Refreshed]
        ?
        ??? New token replaces old token
        ??? OnTokenChanged event fires
        ??? UI updates automatically
        ?
        ? User logs out
        ?
    [Token Cleared]
        ?
        ?
    [No Token]
```

---

## ?? **Security Architecture**

```
???????????????????????????????????????????????????????????????
?  Security Boundaries                                         ?
???????????????????????????????????????????????????????????????

Browser (User A)                    Server
    ?                                  ?
    ?  Circuit A                       ?
    ?  ????????????????????????????   ?
    ?  ? TokenService             ?   ?
    ?  ? - Token: "User A token" ?   ?
    ?  ????????????????????????????   ?
    ?           ?                      ?
    ?           ??? API Request ?????????? [Validates User A token]
    ?                                  ?      ??? Returns User A data
    ?                                  ?
    ?  Circuit B (different tab)       ?
    ?  ????????????????????????????   ?
    ?  ? TokenService             ?   ?
    ?  ? - Token: "User A token" ?   ?  ?? SAME USER, DIFFERENT CIRCUIT
    ?  ????????????????????????????   ?      (browser refresh = new circuit)
    ?           ?                      ?
    ?           ??? API Request ?????????? [Validates User A token]
    ?                                  ?      ??? Returns User A data
    ?                                  ?
????????????????????????????????????????????????????????????????
     ?
Browser (User B - different machine/incognito)
    ?
    ?  Circuit C                       ?
    ?  ????????????????????????????   ?
    ?  ? TokenService             ?   ?
    ?  ? - Token: "User B token" ?   ?
    ?  ????????????????????????????   ?
    ?           ?                      ?
    ?           ??? API Request ?????????? [Validates User B token]
    ?                                  ?      ??? Returns User B data
    ?                                  ?

? ISOLATED: Each circuit has its own token
? SECURE: Tokens stored in server memory, not browser
? AUTOMATIC: Tokens cleared when circuit/browser closes
```

---

## ? **Architecture Checklist**

- ? Single HttpClient configuration
- ? JwtTokenHandler registered as scoped service
- ? TokenService stores tokens per-circuit
- ? All API requests include JWT token
- ? Automatic token refresh from server
- ? Event-driven UI updates
- ? Proper per-user isolation
- ? No global shared state
- ? Clean, maintainable code
- ? Production-ready security

**This is how Blazor Server + JWT should be implemented!** ??
