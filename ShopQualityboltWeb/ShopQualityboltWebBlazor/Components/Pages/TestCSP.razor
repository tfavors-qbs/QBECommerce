@page "/test-csp"
@inject IConfiguration Configuration

<PageTitle>CSP Test</PageTitle>

<h1>Content Security Policy Test</h1>

<div class="alert alert-info">
    <h4>Expected CSP Header:</h4>
    <code>frame-ancestors 'self' @string.Join(" ", GetAribaOrigins())</code>
</div>

<div class="alert alert-warning">
    <h4>Instructions:</h4>
    <ol>
        <li>Open Browser Developer Tools (F12)</li>
        <li>Go to the <strong>Network</strong> tab</li>
        <li>Refresh this page</li>
        <li>Click on this page's request</li>
        <li>Look at <strong>Response Headers</strong></li>
        <li>Find <strong>content-security-policy</strong> header</li>
        <li>Verify it matches the expected value above</li>
    </ol>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5>Current Configuration</h5>
    </div>
    <div class="card-body">
        <h6>Allowed Frame Origins:</h6>
        <ul>
            @foreach (var origin in GetAribaOrigins())
            {
                <li><code>@origin</code></li>
            }
        </ul>
        
        <h6 class="mt-3">Environment:</h6>
        <p><code>@Configuration["ASPNETCORE_ENVIRONMENT"]</code></p>
        
        <h6 class="mt-3">API Address:</h6>
        <p><code>@Configuration["ApiSettings:BaseAddress"]</code></p>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5>Test in Browser Console</h5>
    </div>
    <div class="card-body">
        <p>Run this JavaScript in your browser console to check headers:</p>
        <pre><code>fetch(window.location.href)
  .then(response => {
    console.log('CSP:', response.headers.get('content-security-policy'));
    console.log('X-Frame-Options:', response.headers.get('x-frame-options'));
  });</code></pre>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header bg-danger text-white">
        <h5>If Still Blocked</h5>
    </div>
    <div class="card-body">
        <h6>Possible Issues:</h6>
        <ul>
            <li><strong>Browser Cache:</strong> Clear cache or use Incognito mode</li>
            <li><strong>Reverse Proxy:</strong> Check IIS, Nginx, or Azure App Service config</li>
            <li><strong>web.config:</strong> Look for CSP headers in web.config file</li>
            <li><strong>CDN/WAF:</strong> CloudFlare, Azure Front Door might override headers</li>
        </ul>
        
        <h6 class="mt-3">Azure App Service Fix:</h6>
        <p>If running on Azure, add this to <code>web.config</code>:</p>
        <pre><code>&lt;system.webServer&gt;
  &lt;httpProtocol&gt;
    &lt;customHeaders&gt;
      &lt;remove name="Content-Security-Policy" /&gt;
      &lt;remove name="X-Frame-Options" /&gt;
    &lt;/customHeaders&gt;
  &lt;/httpProtocol&gt;
&lt;/system.webServer&gt;</code></pre>
    </div>
</div>

@code {
    private string[] GetAribaOrigins()
    {
        return Configuration.GetSection("Ariba:AllowedFrameOrigins").Get<string[]>() 
            ?? new[] 
            { 
                "https://*.ariba.com",
                "https://*.sap.com",
                "https://s1.ariba.com",
                "https://service.ariba.com"
            };
    }
}
